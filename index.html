<!DOCTYPE html>
<html>
  <head>
    <title>P5LIVE</title>
    <meta charset="utf-8" />
    <meta
      name="description"
      content="P5LIVE - p5.js collaborate live-coding vj environment!"
    />
    <meta name="author" content="teddavis.org" />

    <link rel="icon" type="image/png" href="includes/icons/icon.png" />
    <link rel="apple-touch-icon" href="includes/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="P5LIVE" />
    <meta
      name="viewport"
      content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"
    />

    <!-- Facebook -->
    <meta property="og:url" content="https://teddavis.org/p5live" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="P5LIVE" />
    <meta
      property="og:description"
      content="p5.js collaborate live-coding vj environment!"
    />
    <meta
      property="og:image"
      content="https://teddavis.org/p5live/includes/social/p5live.png"
    />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="P5LIVE" />
    <meta name="twitter:creator" content="teddavis.org" />
    <meta name="twitter:title" content="P5LIVE" />
    <meta
      name="twitter:description"
      content="p5.js collaborate live-coding vj environment!"
    />
    <meta
      name="twitter:image"
      content="https://teddavis.org/p5live/includes/social/p5live.png"
    />

    <!-- Style -->
    <link rel="stylesheet" type="text/css" media="all" href="style.css?9" />
  </head>
  <body>
    <div id="p5-drop"></div>
    <div id="loader">
      <div id="loader-msg">P5LIVE</div>
      <div class="lds-dual-ring"></div>
      <div id="loader-bg"></div>
    </div>

    <div id="p5-editor">
      <pre id="p5-code" autofocus class="p5-ta"></pre>
      <textarea id="p5-console" class="p5-ta" disabled></textarea>
    </div>

    <iframe
      id="p5-frame"
      sandbox="allow-same-origin allow-scripts"
      srcdoc=""
    ></iframe>
    <div id="p5-frame-cover"></div>

    <div id="refholder">
      <div id="ref"></div>
      <div id="ref-close" onclick="closeRef();">X</div>
    </div>

    <div id="menu">
      <div id="menu-bg"></div>
      <div id="menu-switch" onclick="menuToggle();">X</div>
      <div id="menu-sections">
        <div class="menu-section">
          <div class="menu-section-bg"></div>
          <div class="menu-header">P5LIVE</div>
          <div class="menu-sketches-buttons" id="p5live-buttons">
            <button
              class="menu-button tippy"
              onclick="loadAbout();"
              data-title="About P5LIVE"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-help-circle"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12" y2="17"></line>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="resetP5();"
              data-title="Reset P5LIVE"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-slash"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="showRef();"
              data-title="p5.js Reference<div class='shortcut'>CTRL + R</div>"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-book-open"
              >
                <path
                  class="st0"
                  d="M2,3h6c2.2,0,4,1.8,4,4v14c0-1.7-1.3-3-3-3H2V3z"
                />
                <path
                  class="st0"
                  d="M22,3h-6c-2.2,0-4,1.8-4,4v14c0-1.7,1.3-3,3-3h7V3z"
                />
                <path class="st0" d="M12,23.5" />
                <path class="st0" d="M8.6,10.8H5" />
                <path class="st0" d="M8.6,14.6H5" />
                <path class="st0" d="M8.6,7.1H5" />
                <path class="st0" d="M18.8,10.8h-3.6" />
                <path class="st0" d="M18.8,14.6h-3.6" />
                <path class="st0" d="M18.8,7.1h-3.6" />
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="savePNG();"
              data-title="Export Snapshot<br>PNG [+ CODE]<div class='shortcut'>CTRL + S</div>"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-camera"
              >
                <path
                  d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                ></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="saveHTML();"
              data-title="Export HTML"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-file-text"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </button>
          </div>
        </div>

        <div class="menu-section" id="menu-cocode">
          <div class="menu-section-bg"></div>
          <div class="menu-header" id="menu-cocode-header">
            COCODING<span id="menu-cocode-counter"></span>
          </div>
          <div
            class="menu-sketches-buttons"
            id="cocoding-buttons-active"
            style="display:none;"
          >
            <button
              class="menu-button tippy cocoding-active"
              onclick="cocodingInit();"
              data-title="Stop COCODING"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-power"
              >
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                <line x1="12" y1="2" x2="12" y2="12"></line>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="copyLink(this);"
              data-title="URL to Clipboard"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-link"
              >
                <path
                  d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                ></path>
                <path
                  d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                ></path>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="cloneSketchCOCODING();"
              data-title="Clone Sketch"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-copy"
              >
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path
                  d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                ></path>
              </svg>
            </button>
            <button
              class="menu-button tippy admin-lock"
              id="cocode-layers"
              onclick="cocodeLayers();"
              data-title="Load CoCodeLayers"
              style="display:none;"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-layers"
              >
                <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                <polyline points="2 17 12 22 22 17"></polyline>
                <polyline points="2 12 12 17 22 12"></polyline>
              </svg>
            </button>
            <button
              class="menu-button tippy admin-lock"
              id="cocode-lockdown"
              onclick="toggleLockdown()"
              data-title="Toggle Lockdown"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-unlock"
              >
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V5a4 5 1 0 1 6.9-1"></path>
              </svg>
            </button>
            <button
              class="menu-button tippy admin-lock"
              id="cocode-sync"
              onclick="toggleSync()"
              data-title="Broadcast mouseX/Y + frameCount"
              disabled
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-cast"
              >
                <path
                  d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"
                ></path>
                <line x1="2" y1="20" x2="2" y2="20"></line>
              </svg>
            </button>
          </div>
          <div class="menu-sketches-buttons" id="cocoding-buttons-inactive">
            <button
              class="menu-button tippy cocoding-inactive"
              id="menu-cocoding"
              onclick="cocodingInit();"
              data-title="Start COCODING!"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-share-2"
              >
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
          </div>
          <div
            id="menu-cocode-sketches-holder"
            class="menu-sketches-holder"
            style="display:none;"
            onmouseenter="showUsers();"
            onmouseleave="hideUsers();"
          >
            <div id="menu-cocode-sketches" class="menu-sketches"></div>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-bg"></div>
          <div id="menu-sketches-header" class="menu-header">SKETCHES</div>
          <div class="menu-sketches-buttons">
            <button
              class="menu-button tippy"
              onclick="loadDefault();"
              data-title="New Sketch<div class='shortcut'>CTRL + N</div>"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-file-plus"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="cloneSketch();"
              data-title="Clone Sketch"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-copy"
              >
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path
                  d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                ></path>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="addFolder();"
              data-title="New Folder"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-folder-plus"
              >
                <path
                  d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                ></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
              </svg>
            </button>
            <input
              id="file-input"
              type="file"
              name="name"
              multiple
              style="display: none;"
              onchange="importSketches(this.files);"
              onclick="this.value=null;"
            />
            <button
              class="menu-button tippy"
              onclick="document.getElementById('file-input').click();"
              data-title="Import Sketches"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-upload"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </button>
            <button
              class="menu-button tippy"
              onclick="exportAllSketches();"
              data-title="Export All Sketches"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-download"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
          </div>

          <div id="menu-sketches-holder" class="menu-sketches-holder">
            <div id="menu-sketches" class="menu-sketches"></div>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-bg"></div>
          <div id="menu-settings-header" class="menu-header">SETTINGS</div>
          <div id="menu-settings" class="menu-contents">
            <div>
              <div
                class="tippy-left"
                style="cursor:help;float:left;"
                data-title="Auto-Compile code on keyUp<div class='shortcut'>CTRL + A</div>"
                onclick="autoCompileToggle();"
              >
                <input
                  type="checkbox"
                  id="settings-autocompile"
                  name="settings-autocompile"
                  value="settings-autocompile"
                />
                Live Coding
              </div>
              <select
                id="settings-compiletimer"
                style="display:none;float:right;margin-right:10px;outline:none;border:1px solid #888;background:none;color:#fff;cursor:help;"
                class="tippy"
                data-title="Delay from keyUp to compile"
                onchange="compileTimerChange();"
              >
                <option value="250">250ms</option>
                <option value="500">500ms</option>
                <option value="1000">1000ms</option>
                <option value="2000">2000ms</option>
              </select>
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="noLoop() if window loses focus"
              onclick="ecoRenderToggle();"
            >
              <input
                type="checkbox"
                id="settings-ecorender"
                name="settings-ecorender"
                value="settings-ecorender"
              />
              Eco Render
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Show Cursor <br>(when editor is hidden)<div class='shortcut'>CTRL + C</div>"
              onclick="cursorToggle();"
            >
              <input
                type="checkbox"
                id="settings-canvascursor"
                name="settings-canvascursor"
                value="settings-canvascursor"
              />
              Cursor
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Show Console messages"
              onclick="consoleToggle();"
            >
              <input
                type="checkbox"
                id="settings-console"
                name="settings-console"
                value="settings-console"
              />
              Console
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Show Menu-Tab <br>If unchecked, must use shortcut<div class='shortcut'>CTRL + M</div>"
              onclick="menutabToggle();"
            >
              <input
                type="checkbox"
                id="settings-menutab"
                name="settings-menutab"
                value="settings-menutab"
              />
              Menu Tab
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Toggle code line numbers"
              onclick="linenumbersToggle();"
            >
              <input
                type="checkbox"
                id="settings-linenumbers"
                name="settings-linenumbers"
                value="settings-linenumbers"
              />
              Line Numbers
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Include sketch code with Snapshot"
              onclick="exportcodeToggle();"
            >
              <input
                type="checkbox"
                id="settings-exportcode"
                name="settings-exportcode"
                value="settings-exportcode"
              />
              Snapshot Code
            </div>
            <hr />
            <div
              class="tippy-left"
              style="display:none;cursor:help;"
              data-title="Add extra libs to your sketches, will be added on each compile"
            >
              <span>Libs:</span>
              <input
                type="text"
                id="settings-libs"
                name="settings-libs"
                placeholder="CSV, of, libs"
              />
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Adjust font-size<div class='shortcut'>CTRL + +/-</div>"
            >
              Code Size:
              <input
                type=""
                name="menu-settings-fontsize"
                id="menu-settings-fontsize"
                value="15"
                onkeyup="fontSizeAdjust(this.value);"
              />
              pt
            </div>

            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Code lines"
            >
              Code Background:
              <input
                type="checkbox"
                id="settings-usebg"
                name="settings-usebg"
                value="settings-usebg"
                onchange="themeBGactiveToggle();"
              />
              <div id="pickr" class="pickr"></div>
            </div>
            <div
              class="tippy-left"
              style="cursor:help;"
              data-title="Set theme (ignored in Auto Compile mode)"
            >
              Theme:
              <select
                id="menu-settings-theme"
                onchange="setTheme(this.selectedIndex);"
              >
                <option value="ace/theme/gob">Green on Black</option>
                <option value="ace/theme/ambiance">Ambiance</option>
                <option value="ace/theme/cobalt">Cobalt</option>
                <option value="ace/theme/pastel_on_dark">Pastel on dark</option>
                <option value="ace/theme/twilight">Twilight</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    <textarea style="display:none;" id="p5-template">
function setup() {
	createCanvas(windowWidth, windowHeight);
	
}

function draw() {
	
}</textarea
    >
    <textarea style="display:none;" id="p5-custom">
/* CUSTOM FUNCTIONS FOR P5LIVE */
// keep fullscreen if window resized
function windowResized() {
	resizeCanvas(windowWidth, windowHeight);
}

// custom ease function
function ease(iVal, oVal, eVal){
	let targetX = iVal;
	let dx = targetX - oVal; 
	return oVal += dx * eVal;
}

// processing compatibility
function println(msg){
	print(msg);
}
</textarea
    >
    <textarea style="display:none;" id="p5live-about">
function setup() {
	createCanvas(windowWidth, windowHeight);
	noStroke();
	mouseX = width/2;
	mouseY = height/2;
	pixelDensity(1);
}

function draw() {
	background(0);
	tri(0, 0, mouseX, mouseY, 0, height, 100);
	tri(0, 0, mouseX, mouseY, width, 0, 200);
	tri(width, height, mouseX, mouseY, 0, height, 0);
	tri(width, height, mouseX, mouseY, width, 0, 255);
}

function tri(x1, y1, x2, y2, x3, y3, fc){
	let v = 0.002;
	fill(abs(sin(fc+(frameCount*v)))*255);
	beginShape();
	vertex(x1, y1);
	vertex(x2, y2);
	vertex(x3, y3);
	endShape();
}</textarea
    >

    <!-- Script Styles -->
    <link rel="stylesheet" href="includes/css/nano.min.css" />
    <link rel="stylesheet" href="includes/js/vex/css/vex.css" />
    <link rel="stylesheet" href="includes/js/vex/css/vex-theme-plain.css" />

    <!-- Scripts -->
    <script
      src="includes/js/src-noconflict/ace.js?7"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script
      src="includes/js/src-noconflict/ext-language_tools.js?7"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script src="includes/js/Sortable.js"></script>
    <script src="includes/js/beautify.js"></script>
    <script src="includes/js/pickr.min.js"></script>
    <script src="includes/js/popper.min.js"></script>
    <script src="includes/js/tippy.all.js"></script>
    <script src="includes/js/markdown.min.js"></script>
    <script src="includes/js/download.js"></script>
    <script src="includes/js/vex/js/vex.combined.min.js"></script>
    <script src="includes/js/dropzone.js"></script>

    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="includes/js/socket.io.js"></script>
    <script src="includes/js/rga.js"></script>

    <script type="text/javascript">
      "use strict";

      /* INIT */
      let currentRevision = 22;
      let developBranch = false;

      // resetP5(); // manual reset

      function resetP5() {
        vex.dialog.confirm({
          unsafeMessage:
            "Completely reset P5LIVE?<br><i>All sketches will be removed.</i>",
          callback: function(value) {
            if (value) {
              localStorage.clear();
              location.reload();
            }
          }
        });
      }

      // settings
      let initSettings = {
        version: "1.2.4",
        revision: currentRevision,
        welcome: true,
        fontSize: 15,
        autoCompile: true,
        compileTimer: 500,
        ecoRender: true,
        canvasCursor: true,
        console: true,
        fullscreenMode: false,
        fileName: "",
        linenumbers: false,
        menuMode: true,
        menutab: true,
        exportCode: true,
        debugMode: false,
        safeMode: false,
        sketches: [],
        cocoding: {
          active: false,
          timestamp: null,
          nick: "",
          namespace: "",
          lockdown: false,
          level: "",
          token: 0,
          sync: false,
          request: false,
          writemode: false,
          color: "#00aa00",
          cursor: { row: 0, column: 0 }
        },
        scripts: [
          "includes/p5/p5.min.js",
          "includes/p5/addons/p5.sound.min.js"
        ],
        theme: "ace/theme/gob",
        themeBG: "#052544",
        themeBGactive: true,
        refresh: true
      };

      // init variabless
      let p5editor = document.getElementById("p5-editor"),
        p5code = document.getElementById("p5-code"),
        p5console = document.getElementById("p5-console"),
        p5custom = document.getElementById("p5-custom"),
        p5template = document.getElementById("p5-template").value,
        p5frame = document.getElementById("p5-frame"),
        p5frameCover = document.getElementById("p5-frame-cover"),
        p5f = p5frame.contentWindow,
        p5liveaboutSketch = document.getElementById("p5live-about").value,
        p5script = document.getElementById("holdscript"),
        menuCocode = document.getElementById("menu-cocode"),
        menuCocodeCounter = document.getElementById("menu-cocode-counter"),
        menuCocodeSketches = document.getElementById("menu-cocode-sketches"),
        menuCocodeHolder = document.getElementById(
          "menu-cocode-sketches-holder"
        ),
        menuSketches = document.getElementById("menu-sketches"),
        menuSettings = document.getElementById("menu-settings"),
        menuBG = document.getElementById("menu-bg"),
        settingsFontsize = document.getElementById("menu-settings-fontsize"),
        settingsAutoMode = document.getElementById("settings-autocompile"),
        settingsEcoMode = document.getElementById("settings-ecorender"),
        settingsCanvasCursor = document.getElementById("settings-canvascursor"),
        settingsConsole = document.getElementById("settings-console"),
        settingsMenutab = document.getElementById("settings-menutab"),
        settingsLinenumbers = document.getElementById("settings-linenumbers"),
        settingsExportcode = document.getElementById("settings-exportcode"),
        settingsBGactive = document.getElementById("settings-usebg"),
        settingsCompileTimer = document.getElementById("settings-compiletimer"),
        refHolder = document.getElementById("refholder"),
        ref = document.getElementById("ref"),
        menuPanel = document.getElementById("menu"),
        menuSwitch = document.getElementById("menu-switch"),
        menuTheme = document.getElementById("menu-settings-theme"),
        menuCocoding = document.getElementById("menu-cocode-header"),
        loader = document.getElementById("loader"),
        settings = getSettings(),
        validCode = true,
        sketchLoaded = false,
        pLen = 0,
        paused = false,
        markerID = [],
        errorTimer,
        consoleTimer,
        snippets,
        forceRecompile = false,
        p5vars = { frameCount: 0, mouseX: 0, mouseY: 0 },
        refList = [],
        chars = "abcdefghijklmnopqrstuvwxyz0123456789", // ABCDEFGHIJKLMNOPQRSTUVWXYZ
        cocode,
        editorId,
        p5frameTemplate,
        p5htmlTemplate,
        downloadedRef = false,
        demosLocked = true,
        curPos,
        curPositions = [],
        updateCursor,
        showCursors = false;
      // force off
      settings.debugMode = false;

      // init editor
      let Range = ace.require("ace/range").Range;
      let editor = ace.edit("p5-code");
      editor.setTheme(settings.theme);
      editor.session.setMode("ace/mode/javascript");
      editor.setOptions({
        showPrintMargin: false,
        animatedScroll: false,
        displayIndentGuides: false,
        useWorker: true,
        showLineNumbers: false,
        showGutter: false,
        tabSize: 4,
        useSoftTabs: false
      });

      p5editor.style.visibility = "visible";

      // ICONS!
      let iconFolderEmpty =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';

      let iconFolderCollapse =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-minus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg>';

      let iconFolderExpand =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>';

      let iconFileLines =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';

      let iconSettings =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>';

      let iconRename =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=" feather-small feather-edit-3"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>';

      let iconRefresh =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';

      let iconExport =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';

      let iconRemove =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';

      let iconCopy =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

      let iconUnlock =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V5a4 5 1 0 1 6.9-1"></path></svg>';

      let iconLock =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';

      let iconEdit =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';

      let iconToggleLeft =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="8" cy="12" r="3"></circle></svg>';

      let iconToggleRight =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="16" cy="12" r="3"></circle></svg>';

      let iconScreencast =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>';

      let iconPower =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>';

      let iconXCircle =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';

      let iconCheckCircle =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';

      let iconShield =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';

      let iconUser =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';

      let iconUsers =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';

      let iconUserCheck =
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-check"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>';

      // code-line color picker
      function loadColorPicker() {
        let defaultColor = settings.themeBG;
        if (defaultColor.includes("#")) {
          defaultColor = defaultColor.substring(1);
        }
        let pickr = Pickr.create({
          el: ".pickr",
          theme: "nano", // or 'monolith', or 'nano'
          default: defaultColor,

          components: {
            preview: true,
            opacity: true,
            hue: true,

            interaction: {
              input: true,
              cancel: false,
              save: true
            }
          },

          // rename buttons
          strings: {
            save: "Set", // Default for save button
            cancel: "Close" // Default for cancel button
          }
        });

        pickr
          .on("init", (color, instance) => {
            setBG(defaultColor);
          })
          .on("change", (color, instance) => {
            setBG(color.toHEXA().join(""));
          })
          .on("save", (color, instance) => {
            instance.hide();
          })
          .on("cancel", instance => {
            instance.hide();
          });
      }

      let options = {
        group: { name: "sketches" },
        animation: 0,
        filter: ".sortable-placeholder, .demo",
        emptyInsertThreshold: 0,
        dragClass: "sortable-drag",
        ghostClass: "sortable-ghost",
        draggable: ["li", "ul"],
        swapInvert: true,
        store: {
          set: function(sortable) {
            getOrder();
          }
        }
      };

      let includeScripts = [
        {
          local: "includes/p5/p5.min.js",
          remote: "https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.min.js"
        },
        {
          local: "includes/p5/addons/p5.dom.min.js",
          remote:
            "https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"
        },
        {
          local: "includes/p5/addons/p5.sound.min.js",
          remote:
            "https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/addons/p5.sound.min.js"
        }
      ];

      // markers for COCODING
      // built upon: https://stackoverflow.com/a/24812641/10885535
      let marker = {};
      marker.cursors = [];
      marker.update = function(html, markerLayer, session, config) {
        let start = config.firstRow,
          end = config.lastRow;
        let cursors = this.cursors;
        for (let i = 0; i < cursors.length; i++) {
          let pos = this.cursors[i];
          if (pos.row < start) {
            continue;
          } else if (pos.row > end) {
            break;
          } else {
            // compute cursor position on screen
            // this code is based on ace/layer/marker.js
            let screenPos = session.documentToScreenPosition(
              pos.row,
              pos.column
            );
            let height = config.lineHeight;
            let width = config.characterWidth;
            let top = markerLayer.$getTop(screenPos.row, config);
            let left = markerLayer.$padding + screenPos.column * width;

            // update if exists + rebuild on textsize change
            let elm = document.getElementById("cursor_" + pos.id);
            if (elm != undefined) {
              elm.parentNode.removeChild(elm);
            }

            // can add any html here
            let el = document.createElement("div");
            el.id = "cursor_" + pos.id;
            el.className = "cursor";
            el.style.position = "absolute";
            el.style.height = height + "px";
            el.style.width = width + "px";
            el.style.top = top + "px";
            el.style.left = left + "px";
            if (pos.id != settings.cocoding.nick) {
              el.style.borderLeft = "3px solid " + pos.color;
            } else {
              let cursorSelf = document.getElementsByClassName("ace_cursor")[0];
              cursorSelf.style.borderColor = pos.color;
              el.style.left = left + 3 + "px";
            }
            el.style.zIndex = 9999999;
            el.style.color = "#000";
            el.style.cursor = "help";
            if (!showCursors) {
              el.style.display = "none";
            }
            el.innerHTML =
              '<div class="cursor-label" style="background:' +
              pos.color +
              ';top:-8pt;">' +
              pos.id +
              "</div>";
            p5editor.appendChild(el);
          }
        }
      };
      marker.redraw = function() {
        this.session._signal("changeFrontMarker");
      };
      marker.session = editor.session;
      marker.session.addDynamicMarker(marker, true);

      class CocodeApp {
        constructor(namespace) {
          this.initialized = false;
          this.socket = "";
          this.namespace = namespace;
          if (!window.location.hostname.includes("teddavis.org")) {
            this.socket = io("/" + this.namespace, {
              transports: ["websocket"],
              secure: true,
              query: { nick: settings.cocoding.nick }
            }); // io('http://localhost:5000/' + this.namespace);
          } else {
            if (developBranch) {
              this.socket = io(
                "https://p5live-server-develop.glitch.me/" + this.namespace,
                {
                  transports: ["websocket"],
                  secure: true,
                  query: { nick: settings.cocoding.nick }
                }
              );
            } else {
              this.socket = io(
                "https://p5live-server.glitch.me/" + this.namespace,
                {
                  transports: ["websocket"],
                  secure: true,
                  query: { nick: settings.cocoding.nick }
                }
              );
            }
          }
          this.rgaConnect();
          this.users = {};
          editor.setWrapBehavioursEnabled(false);
          // editor.getSession().on('change', function(delta){
          // 	curPos = delta.start;
          // 	curPositions.push(delta.start);
          // 	checkErrors();
          // });

          this.updateColor();
          this.token();

          this.socket.on("init", () => {
            setTimeout(function() {
              editor.setValue(p5template, 1);
            }, 100);
          });

          this.socket.on("syncSettings", data => {
            let settingsUpdate = JSON.parse(data);
            settings.cocoding.lockdown = settingsUpdate.lockdown;
            settings.cocoding.sync = settingsUpdate.sync;
            updateSettings();

            //lockdown
            if (settings.cocoding.lockdown) {
              editor.setReadOnly(true);
              if (
                settings.cocoding.level == "admin" ||
                settings.cocoding.writemode
              ) {
                editor.setReadOnly(false);
              }
            } else {
              editor.setReadOnly(false);
            }
            updateToggleLockdown();

            if (settings.cocoding.sync) {
              if (settingsUpdate.fc > 0) {
                p5f.frameCount = settingsUpdate.fc;
              }
            }
            updateToggleSync();
            // let settingsSync = document.getElementById('cocode-sync');
            // toggleButtonActive(settingsSync, settings.cocoding.sync);
          });

          this.socket.on("cocodeReady", () => {
            if (!this.initialized) {
              document.getElementById(
                "cocoding-buttons-inactive"
              ).innerHTML = document.getElementById(
                "cocoding-buttons-active"
              ).innerHTML;
              document.getElementById("cocoding-buttons-active").innerHTML = "";
              loadTippy();
              this.initialized = true;
            }
          });

          this.socket.on("full", () => {
            vex.dialog.alert({
              message: "Sorry COCODING is full at the moment.",
              callback: function() {
                cocodingExit(loadLatest());
              }
            });
          });

          this.socket.on("setLevel", statusMode => {
            settings.cocoding.level = statusMode;
            updateSettings();
            if (statusMode != "admin") {
              let adminDivs = document.getElementsByClassName("admin-lock");
              for (let i = 0; i < adminDivs.length; i++) {
                adminDivs[i].setAttribute("disabled", "disabled");
              }
            }
          });

          this.socket.on("dispatchSyncEvent", evData => {
            let ev = JSON.parse(evData);
            let copy;
            if (ev.mode == "keyboard") {
              copy = new KeyboardEvent(ev.type, ev.options);
            } else if (ev.mode == "mouse") {
              copy = new MouseEvent(ev.type, ev.options);
            }
            p5f.dispatchEvent(copy);
            p5f.frameCount = ev.fc;
          });

          this.socket.on("recompile", force => {
            buildSketch(force); //
            updateBackground();
          });

          this.socket.on("rename", nick => {
            settings.cocoding.nick = nick;
            updateSettings();
          });

          this.socket.on("codeReplaceRequest", data => {
            vex.dialog.confirm({
              unsafeMessage:
                'Replace code request<br><hr><div class="code-replace-header">User </div>' +
                data.userID +
                '<br><div class="code-replace-header">SketchName</div>' +
                data.sketchName +
                '<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">' +
                data.sketchCode +
                "</textarea>",
              callback: function(value) {
                if (value) {
                  let checkedCode = document.getElementById(
                    "code-replace-textarea"
                  ).value;
                  cocode.codeReplace({ code: checkedCode });
                  // editor.setValue(checkedCode, 1);
                  // window.setTimeout(function(){cocode.recompile()}, 300);
                  // window.setTimeout(function(){recompile(true)}, 400);
                } else {
                  cocode.codeReplaceReject(data);
                }
              }
            });
          });

          this.socket.on("codeReplaceReject", data => {
            vex.dialog.alert({
              message: "Request denied.",
              callback: function() {}
            });
          });

          this.socket.on("codeReplaceBusy", () => {
            vex.dialog.alert({
              message: "Busy with another request, try later.",
              callback: function() {}
            });
          });

          this.socket.on("requestReject", () => {
            settings.cocoding.request = false;
            updateSettings();
          });

          this.socket.on("codeReplace", data => {
            RGA.AceEditorRGA.prototype.destroy;
            RGA.AceEditorRGA._lastText = data.code;
            if (settings.cocoding.level == "admin") {
              editor.setValue("", 1);
              window.setTimeout(function() {
                editor.setValue(data.code, 1);
              }, 300);
            }
            window.setTimeout(function() {
              cocode.recompile();
            }, 400);
            window.setTimeout(function() {
              recompile(true);
            }, 500);
          });

          this.socket.on("toggleEdit", writeMode => {
            if (writeMode) {
              settings.cocoding.writemode = true;
              settings.cocoding.request = false;
              updateSettings();
              editor.setReadOnly(false);
            } else {
              settings.cocoding.writemode = false;
              updateSettings();
              editor.setReadOnly(true);
            }
          });

          this.socket.on("syncCursors", usersRaw => {
            this.syncCursors(usersRaw);
          });

          this.socket.on("syncUsers", usersRaw => {
            this.users = JSON.parse(usersRaw);
            let users = [];
            for (let key in this.users) {
              users.push(this.users[key]);
            }

            // sort by request or writemode
            if (settings.cocoding.level == "admin") {
              users
                .sort(function(userA, userB) {
                  return (
                    userA.level - userB.level ||
                    userA.request - userB.request ||
                    userA.writemode - userB.writemode
                  );
                })
                .reverse();
            } else {
              users.reverse();
            }

            menuCocodeSketches.innerHTML = "";
            let activeSelf = "";
            let usersHTML = "";
            let usersSelf;
            menuCocodeCounter.innerHTML = users.length;
            for (let i = 0; i < users.length; i++) {
              if (users[i].nick != settings.cocoding.nick) {
                let userNav = "";
                if (settings.cocoding.lockdown) {
                  if (settings.cocoding.level == "admin") {
                    if (users[i].writemode) {
                      userNav =
                        '<a class="menu-sketch-button tippy" onclick="cocode.toggleEdit(\'' +
                        users[i].nick +
                        '\')" data-title="Toggle EditMode">' +
                        iconToggleRight +
                        "</a>";
                    } else {
                      if (users[i].request) {
                        userNav =
                          '<a class="menu-sketch-button tippy" onclick="cocode.requestReject(\'' +
                          users[i].nick +
                          '\')" data-title="Reject Request">' +
                          iconXCircle +
                          '</a><a class="menu-sketch-button tippy" onclick="cocode.toggleEdit(\'' +
                          users[i].nick +
                          '\')" data-title="Toggle EditMode">' +
                          iconCheckCircle +
                          "</a>";
                      } else {
                        userNav =
                          '<a class="menu-sketch-button tippy" onclick="cocode.toggleEdit(\'' +
                          users[i].nick +
                          '\')" data-title="Toggle EditMode">' +
                          iconToggleLeft +
                          "</a>";
                      }
                    }
                  }
                }

                let active = "";
                let marq = "";
                let writeClass = "";
                let userIcon = iconUsers;
                if (settings.cocoding.lockdown) {
                  if (users[i].request) {
                    writeClass = " write-req ";
                  } else if (users[i].writemode || users[i].level == "admin") {
                    writeClass = " write-access ";
                    if (users[i].level == "admin") {
                      userIcon = iconShield;
                    }
                  }
                }
                if (users[i].nick.length > 10) {
                  marq = "marq";
                }
                if (users[i].status == "blur") {
                  active = 'style="opacity:.5;"';
                }
                usersHTML +=
                  '<li id="user-' +
                  users[i].nick +
                  '" class="item-sketch menu-sketch-holder ' +
                  writeClass +
                  '"><div class="menu-sketch-nav">' +
                  userNav +
                  '</div><div class="menu-sketch ' +
                  marq +
                  '" ' +
                  active +
                  '><span style="padding-top:4px;background:' +
                  users[i].color +
                  ';">' +
                  userIcon +
                  "</span> " +
                  users[i].nick +
                  "</div></li>";
              } else {
                usersSelf = users[i];
                if (usersSelf.status == "blur") {
                  activeSelf = 'style="opacity:.5;"';
                }
              }
            }
            let selfNav = "";
            let userIcon = iconUser;
            if (
              settings.cocoding.level == "user" &&
              settings.cocoding.lockdown &&
              !settings.cocoding.writemode
            ) {
              selfNav =
                '<div class="menu-sketch-nav"><a id="request-' +
                settings.cocoding.nick +
                '" class="menu-sketch-button tippy " onclick="cocode.editRequest(\'' +
                settings.cocoding.nick +
                '\')" data-title="Request Edit">' +
                iconEdit +
                "</a></div>";
            }

            let writeClass = "";
            if (
              settings.cocoding.lockdown &&
              settings.cocoding.level != "admin"
            ) {
              if (usersSelf.request) {
                writeClass = " write-req ";
              } else if (settings.cocoding.writemode) {
                writeClass = " write-access ";
                userIcon = iconUserCheck;
              }
            }

            if (settings.cocoding.level == "admin") {
              userIcon = iconShield;
            }

            let marq = "";
            if (settings.cocoding.nick.length > 10) {
              marq = "marq";
            }

            menuCocodeSketches.innerHTML =
              '<li class="self item-sketch menu-sketch-holder ' +
              writeClass +
              '" ' +
              activeSelf +
              " >" +
              selfNav +
              '<div class="menu-sketch tippy ' +
              marq +
              '" data-title="Click to Rename" onclick="cocode.rename();"><span id="cocodingself" style="padding-top:4px;background:' +
              settings.cocoding.color +
              ';">' +
              userIcon +
              "</span> " +
              settings.cocoding.nick +
              "</div></li>" +
              usersHTML;
            loadTippy();
            this.syncCursors(usersRaw);
          });
        }

        rgaConnect() {
          RGA.AceEditorRGA.setup(editor, this.socket);
        }

        userBG(newVal) {
          document.getElementById("cocodingself").style.background = newVal;
        }

        rename() {
          vex.dialog.open({
            input: [
              '<label for="nick">Nickname</label><br>',
              '<input id="cocodingnick" name="nick" type="text" value="' +
                settings.cocoding.nick +
                '">',
              "<br><br>",

              '<label for="color" style="display:block;">Cursor Color</label><br>',
              '<input id="cocodingcolor" name="pickr" type="text" autocomplete="off" readonly class="cocode-pickr" style="cursor:pointer;">'
            ].join(""),
            callback: function(data) {
              if (data) {
                //console.log(data);
                if (data.nick != settings.cocoding.nick) {
                  let newName = data.nick.replace(/["']/g, "");
                  if (
                    newName.trim() != "" &&
                    newName != settings.cocoding.nick
                  ) {
                    settings.cocoding.nick = newName;
                    cocode.login();
                    updateSettings();
                  }
                }
                if (
                  data.pickr != undefined &&
                  data.pickr != settings.cocoding.color
                ) {
                  settings.cocoding.color = data.pickr;
                  cocode.userBG(data.pickr);
                  cocode.updateColor();
                  updateSettings();
                } else {
                  //settings.cocoding.color = data.pickr;
                }
              }
            },
            afterOpen: function() {
              document.getElementById("cocodingnick").select();
              document.getElementById("cocodingcolor").style.background =
                settings.cocoding.color;
              let defaultColor = "00aa00";

              if (settings.cocoding.color != null) {
                defaultColor = settings.cocoding.color;
              }
              //document.querySelectorAll('.ace_cursor')[0].style.background = defaultColor;
              const pickr2 = Pickr.create({
                el: "#cocodingcolor",
                useAsButton: true,
                theme: "nano",
                default: defaultColor,

                components: {
                  preview: true,
                  opacity: false,
                  hue: true,

                  // Input / output Options
                  interaction: {
                    input: true,
                    cancel: true,
                    save: true
                  }
                },

                // rename buttons
                strings: {
                  save: "Set", // Default for save button
                  cancel: "Close" // Default for cancel button
                }
              });

              pickr2
                .on("change", (color, instance) => {})
                .on("save", (color, instance) => {
                  document.getElementById("cocodingcolor").value =
                    "#" + color.toHEXA().join("");
                  document.getElementById("cocodingcolor").style.background =
                    "#" + color.toHEXA().join("");
                  document.getElementById("cocodingcolor").style.color =
                    "#" + color.toHEXA().join("");
                  instance.hide();
                })
                .on("cancel", instance => {
                  instance.hide();
                });
            }
          });
        }

        login() {
          this.socket.emit("login", settings.cocoding.nick);
        }

        updateColor() {
          this.socket.emit("updateColor", settings.cocoding.color);
        }

        token() {
          this.socket.emit("token", settings.cocoding.token);
        }

        lockdown(lockdownMode) {
          this.socket.emit("lockdown", lockdownMode);
        }

        codeReplaceRequest(userID, sketchName, sketchCode) {
          let reqData = {
            userID: userID,
            sketchName: sketchName,
            sketchCode: sketchCode
          };
          this.socket.emit("codeReplaceRequest", reqData);
        }

        codeReplaceReject(data) {
          this.socket.emit("codeReplaceReject", data);
        }

        codeReplace(data) {
          this.socket.emit("codeReplace", data);
        }

        editRequest(userID) {
          settings.cocoding.request = !settings.cocoding.request;
          updateSettings();

          let reqData = { userID: userID, mode: settings.cocoding.request };
          this.socket.emit("editRequest", reqData);
        }

        toggleEdit(userID) {
          this.socket.emit("toggleEdit", { userID: userID });
        }

        requestReject(userID) {
          this.socket.emit("rejectRequest", { userID: userID });
        }

        dispatchSyncEvent(evMode, evType, evOpts) {
          let ev = {
            mode: evMode,
            type: evType,
            options: evOpts,
            fc: p5f.frameCount
          };
          this.socket.emit("dispatchSyncEvent", ev);
        }

        recompile(force) {
          this.socket.emit("recompile", force);
        }

        sync(syncMode) {
          this.socket.emit("sync", { mode: syncMode, fc: p5f.frameCount });
        }

        cursorPos(pos) {
          this.socket.emit("cursor", pos);
        }

        syncCursors(usersRaw) {
          this.users = JSON.parse(usersRaw);
          marker.cursors = [];

          let elements = document.getElementsByClassName("cursor");
          while (elements.length > 0) {
            elements[0].parentNode.removeChild(elements[0]);
          }

          for (let key in this.users) {
            marker.cursors.push({
              row: this.users[key].cursor.row,
              column: this.users[key].cursor.column,
              color: this.users[key].color,
              id: this.users[key].nick
            });
          }
          marker.redraw();
        }
      }

      // cocode extras

      function showUsers() {
        let cursorSel = document.getElementsByClassName("cursor");
        for (let i = 0; i < cursorSel.length; i++) {
          cursorSel[i].style.display = "block";
        }
        showCursors = true;
      }

      function hideUsers() {
        let cursorSel = document.getElementsByClassName("cursor");
        for (let i = 0; i < cursorSel.length; i++) {
          cursorSel[i].style.display = "none";
        }
        showCursors = false;
      }

      /* FANCY EDITOR FUNCTIONS */

      editor.getSession().selection.on("changeCursor", function() {
        //console.log(editor.getCursorPosition());
        curPos = editor.getCursorPosition();

        // sync cursors in COCODING
        if (settings.cocoding.active && cocode != null) {
          updateCursor = window.setTimeout(function() {
            cocode.cursorPos(curPos);
          }, 200);
        }
        // curPositions.push(editor.getCursorPosition());
      });

      editor.getSession().on("change", function(delta) {
        curPos = delta.start;
        curPositions.push(delta.start);
        checkErrors();
      });

      // check for errors
      editor.getSession().on("changeAnnotation", function() {
        let annot = editor.getSession().getAnnotations();

        // extra debug info (too raw.. but nice to have better p5.js specific debugging in console)
        // for (var key in annot) {
        // 	if (annot.hasOwnProperty(key))
        // 	console.log(annot[key].text + "on line " + " " + annot[key].row);
        // }

        validCode = true;
        for (let i = 0; i < annot.length; i++) {
          if (annot[i].type === "error") {
            addMarker(annot[i].row);
            validCode = false;
          }
        }
        if (validCode) {
          removeMarkers();
        }
      });

      function addMarker(n) {
        let elementPos = markerID
          .map(function(x) {
            return x.line;
          })
          .indexOf(n);
        if (elementPos === -1) {
          markerID.push({
            line: n,
            id: editor.session.addMarker(
              new Range(n, 0, n, 7000),
              "myMarker",
              "fullLine"
            )
          });
        }
      }

      function removeMarkers() {
        for (let i = 0; i < markerID.length; i++) {
          editor.session.removeMarker(markerID[i].id);
        }
        markerID = [];
      }

      // set editor BG
      editor.renderer.on("afterRender", function() {
        adjustLines();
      });

      function adjustLines() {
        let pcode = document.getElementsByClassName("ace_line");
        for (let i = 0; i < pcode.length; i++) {
          let pitem = pcode[i];
          let pcontents = pitem.innerHTML;
          if (settings.themeBGactive) {
            pitem.innerHTML =
              '<span class="ace_line_bg" style="background:' +
              settings.themeBG +
              '">' +
              pcontents +
              "</span>";
          }
        }
      }

      /* CMD-KEYS (remove key conflicts) */
      editor.commands.removeCommands([
        "gotoright",
        "movelinesup",
        "movelinesdown",
        "gotolinestart",
        "splitline",
        "gotolineend",
        "golineup",
        "jumptomatching",
        "golinedown",
        "transposeletters"
      ]);

      // replace backspace w/o ctrl + h
      editor.commands.addCommand({
        name: "backspace",
        bindKey: {
          win: "Shift-Backspace|Backspace",
          mac: "Ctrl-Backspace|Shift-Backspace|Backspace"
        },
        exec: function(e) {
          e.remove("left");
        },
        multiSelectAction: "forEach",
        scrollIntoView: "cursor"
      });

      // replace gotoright w/o ctrl + f
      editor.commands.addCommand({
        name: "gotoright",
        bindKey: { win: "Right", mac: "Right" },
        exec: function(e, t) {
          e.navigateRight(t.times);
        },
        multiSelectAction: "forEach",
        scrollIntoView: "cursor",
        readOnly: !0
      });

      // replace golineup w/o ctrl + p
      editor.commands.addCommand({
        name: "golineup",
        bindKey: { win: "Up", mac: "Up" },
        exec: function(e, t) {
          e.navigateUp(t.times);
        },
        multiSelectAction: "forEach",
        scrollIntoView: "cursor",
        readOnly: !0
      });

      // replace golinedown w/o ctrl + n
      editor.commands.addCommand({
        name: "golinedown",
        bindKey: { win: "Down", mac: "Down" },
        exec: function(e, t) {
          e.navigateDown(t.times);
        },
        multiSelectAction: "forEach",
        scrollIntoView: "cursor",
        readOnly: !0
      });

      // fix german keyboard binding for /
      editor.commands.bindKey("cmd-shift-7", "togglecomment");
      editor.commands.bindKey("ctrl-shift-7", "togglecomment");

      // beautify!
      let beautifyOptions = {
        indent_size: "1",
        indent_char: "\t",
        max_preserve_newlines: "5",
        preserve_newlines: true,
        keep_array_indentation: false,
        break_chained_methods: false,
        indent_scripts: "normal",
        brace_style: "collapse",
        space_before_conditional: false,
        unescape_strings: false,
        jslint_happy: false,
        end_with_newline: false,
        wrap_line_length: "0",
        indent_inner_html: false,
        comma_first: false,
        e4x: false
      };

      /* DEBUG EDITOR COMMANDS + STORAGE */

      // list ace editor commands
      function listCommands() {
        let cmds = editor.commands.commands;
        let k = [];
        for (let cmd in cmds) {
          k.push(cmd.name + " = " + cmd.bindKey);
        }
      }

      // check storageKeys
      function getKeys() {
        let k = [];
        for (let key in localStorage) {
          k.push(key);
        }
      }

      if (settings.debugMode) {
        listCommands();
        getKeys();
      }

      /* p5 iframe communication */

      // mark error line
      window.document.addEventListener("myEvent", handleEvent, false);
      function handleEvent(e) {
        if (e.detail.lineNumber != undefined) {
          let errorLine = parseInt(e.detail.lineNumber) - 1;
          addMarker(errorLine);
        } else {
          removeMarkers();
        }
        // sketchloaded
        if (e.detail.status) {
          // p5f.frameCount = p5vars.frameCount;
          // p5f.mouseX = p5vars.mouseX;
          // p5f.mouseY = p5vars.mouseY;

          // p5f.setup(); // better than clear/background, reinit w/ updated vars
          //p5varsReset();
          sketchLoaded = true;
        } else {
          sketchLoaded = false;
          // set timer for refreshing if error
        }
      }

      /* SETTINGS */

      // init settings
      loadSettings();

      // get settings from localstorage
      function getSettings() {
        let tempSettings = initSettings;
        if (localStorage.hasOwnProperty("settings")) {
          tempSettings = JSON.parse(localStorage.getItem("settings"));
        }
        return tempSettings;
      }

      // react to settings once gathered
      function loadSettings() {
        // make sure all settings are there
        if (
          settings.revision == undefined ||
          settings.revision < currentRevision
        ) {
          settings.revision = currentRevision;
          settings.version = initSettings.version;
          Object.keys(initSettings).forEach(function(k) {
            if (!settings.hasOwnProperty(k)) {
              settings[k] = initSettings[k];
            } else if (typeof initSettings[k] === "object") {
              Object.keys(initSettings[k]).forEach(function(kk) {
                if (!settings[k].hasOwnProperty(kk)) {
                  settings[k][kk] = initSettings[k][kk];
                }
              });
            }
            settings.refresh = true;
          });
          updateSettings();
        }

        fontSizeUpdate();
        autoCompileUpdate();
        compileTimerUpdate();
        menuToggleUpdate();
        ecoRenderUpdate();
        cursorToggleUpdate();
        consoleToggleUpdate();
        menutabToggleUpdate();
        linenumbersUpdate();
        exportcodeUpdate();
        loadTheme();
        themeBGactiveToggleUpdate();
        loadSnippets();
        loadSketchTemplate();
        loadHTMLTemplate();
        loadColorPicker();
        vex.defaultOptions.className = "vex-theme-plain";
        legacySettings(); // update sketches from 1.0.2
        if (settings.cocoding != undefined) {
          settings.cocoding.active = false;
        } else {
          // settings = initSettings;
          // updateSettings();
          // window.setTimeout(function(){location.reload(true);}, 300);
        }
        settings.safeMode = false;
        updateSketches();
        hideLoader();
        if (getParam("cc") != undefined) {
          if (getParam("cc").length != 5) {
            cocodingExit(loadLatest());
            return false;
          }
          let ccSpace = getParam("cc");
          if (settings.cocoding.token != hashCode(ccSpace)) {
            cocodingReset();
          }
          settings.cocoding.active = true;
          if (settings.cocoding.timestamp == null) {
            settings.cocoding.timestamp = timeStamp();
          }
          menuCocode.style.display = "block";
          settings.fileName = ccSpace;
          settings.cocoding.namespace = settings.fileName;
          if (
            settings.cocoding.nick == undefined ||
            settings.cocoding.nick == ""
          ) {
            settings.cocoding.nick = makeid(6);
          }
          updateSketches();
          cocoding();
        } else if (settings.welcome) {
          loadAbout();
          vex.dialog.alert({
            unsafeMessage:
              'Welcome to P5LIVE! <br><br><div class="code-replace-header">Storage</div>Sketches are only stored your browser\'s localStorage, so export often.<br><br><div class="code-replace-header">Shortcuts (most important)</div>CTRL + N » new sketch<br>CTRL + ENTER » softCompile<br>CTRL + E » editor toggle<br>CTRL + M » menu toggle'
          });
          settings.welcome = false;
          updateSettings();
        } else if (window.location.hash) {
          if (window.location.hash.substring(1) === "new") {
            loadDefault();
          } else if (
            window.location.hash.substring(1).toLowerCase() === "bug"
          ) {
            settings.safeMode = true;
            updateSettings();
            loadSketch(settings.fileName);
          } else {
            loadRef();
            loadSketch(settings.fileName);
          }
        } else {
          cocodingReset();
          loadSketch(settings.fileName);
        }
      }

      function getParam(paramSearch) {
        let params = document.location.search.substring(1).split("&");
        for (let i = 0; i < params.length; i++) {
          let keyVal = params[i].split("=");
          if (keyVal[0] == paramSearch) {
            return keyVal[1];
          }
        }
      }

      /*	SKETCHES TASKS	*/
      // set settings to localstorage
      function updateSettings() {
        localStorage.setItem("settings", JSON.stringify(settings));
        if (settings.debugMode) {
          console.log(getSettings());
        }
      }

      // set sketches list to localstorage
      function updateSketches() {
        updateSettings();
        initSortable();
      }

      // padding version numbers of sketch
      function pad(num, size) {
        var s = "0000" + num;
        return s.substr(s.length - size);
      }

      // use sketch versions instead of timestamp
      function versionCheck(sketchName) {
        let tempName = sketchName;
        let forkScores = tempName.split("_");
        if (forkScores.length > 0) {
          let forkVersion = forkScores[forkScores.length - 1];
          if (!isNaN(forkVersion) && forkVersion.length == 3) {
            forkScores[forkScores.length - 1] = pad(
              parseInt(forkVersion) + 1,
              3
            );
          } else {
            forkScores.push("001");
          }
        }
        tempName = forkScores.join("_");

        // check entire sketches for dup version name
        while (searchSketches(tempName, settings.sketches)) {
          tempName = versionCheck(tempName);
        }
        return tempName;
      }

      // save sketch as...
      function cloneSketch() {
        let forkName = versionCheck(settings.fileName);
        settings.fileName = forkName;
        settings.sketches.unshift({ type: "sketch", name: settings.fileName });
        updateSketches();
        localStorage[settings.fileName] = editor.getValue();
        editor.focus();
        editor.session.off("change", cloneSketch);
      }

      function cloneSketchCOCODING() {
        let forkSession =
          "cc_" +
          settings.cocoding.namespace +
          "_" +
          settings.cocoding.timestamp;
        if (searchJSON(settings.sketches, "name", forkSession).length == 0) {
          addFolder(forkSession);
        }
        // let forkName = forkSession+'_'+timeStamp();
        let forkName = versionCheck(settings.fileName);

        settings.fileName = forkName;
        updateSettings();
        let forkObj = searchJSON(settings.sketches, "name", forkSession)[0];
        forkObj.contents.unshift({ type: "sketch", name: forkName });
        forkObj.toggle = "expand";
        updateSketches();
        localStorage[forkName] = editor.getValue();
      }

      // load sketch
      function loadSketch(sketch) {
        if (settings.cocoding.active) {
          vex.dialog.confirm({
            message: "Exit COCODING?",
            callback: function(value) {
              if (value) {
                cocodingExit(sketch);
              }
            }
          });

          // *** launch once better RGA solution for complete text replace is found
          /*
				if(settings.cocoding.level == 'admin'){
					vex.dialog.confirm({
						unsafeMessage:'Replace code with<br><hr><div class="code-replace-header">SketchName</div>'+sketch+'<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">'+localStorage[sketch]+'</textarea>',
						callback: function (value) {
							if (value) {
								let checkedCode = document.getElementById('code-replace-textarea').value;
								cocode.codeReplace({'code':checkedCode});
								//cocode.codeReplace({'code':localStorage[sketch]});
								// editor.setValue(localStorage[sketch], 1);
								// window.setTimeout(function(){cocode.recompile()}, 300);
								// window.setTimeout(function(){recompile(true)}, 400);
							}
						}
					})
				}else{
					if(settings.cocoding.writemode || !settings.cocoding.lockdown){
						vex.dialog.confirm({
							unsafeMessage: 'Request to replace code with:\n' + sketch,
							callback: function (value) {
								if (value) {
									cocode.codeReplaceRequest(settings.cocoding.nick, sketch, localStorage[sketch]);
								}
							}
						})
					}else{
						vex.dialog.alert({
							message:"Editor is locked, request to edit.",
							callback: function(){}
						})
					}
				}
				*/
        } else {
          if (localStorage.hasOwnProperty(sketch)) {
            editor.getSession().off("change", cloneSketch);
            // auto expand folder (incase of short-cut selection)
            recursiveFolderExpand(settings.sketches, sketch, "");
            settings.fileName = sketch;
            editor.setValue(localStorage[settings.fileName], 1);

            pLen = editor.getValue().length;
            updateSketches();

            setTimeout(function() {
              p5varsReset();
              recompile(true);
            }, 200);

            // restart undo to prevent overwrite selected sketch
            editor.getSession().setUndoManager(new ace.UndoManager());
            editor.focus();
            let checkDemo = searchJSON(settings.sketches, "name", "demos"); //listSketches(settings.sketches.demo);
            if (searchSketches(settings.fileName, checkDemo) && demosLocked) {
              editor.getSession().on("change", cloneSketch);
            }
          } else if (
            !localStorage.hasOwnProperty(sketch) &&
            searchSketches(settings.fileName, settings.sketches)
          ) {
            vex.dialog.confirm({
              message: "Sketch code missing, remove from list?",
              callback: function(value) {
                if (value) {
                  removeItemProcess(settings.fileName);
                }
              }
            });
          } else {
            // start new sketch
            if (listSketches(settings.sketches).length > 0) {
              settings.fileName = loadLatest();
              updateSettings();
              loadSketch(settings.fileName);
            } else {
              loadDefault();
            }
          }
        }
      }

      function loadSketchTemplate() {
        let tempPath = "includes/templates/p5live_sketch.html";
        let request = new XMLHttpRequest();
        request.open("GET", tempPath, false);
        request.send();
        let el = document.createElement("html");
        el.innerHTML = request.responseText;
        p5frameTemplate = el;
      }

      // load top sketch
      function loadLatest() {
        return listSketches(settings.sketches)[0];
      }

      // pause sketch on demand
      function pauseSketch() {
        if (sketchLoaded) {
          paused = !paused;
          if (paused) {
            p5f.noLoop();
          } else {
            p5f.loop();
          }
        }
      }

      function searchSketches(sketchName, obj) {
        let sketchesFlat = JSON.stringify(obj);
        if (sketchesFlat.indexOf('"' + sketchName + '"') > -1) {
          return true;
        } else {
          return false;
        }
      }

      function searchJSON(obj, key, value, out) {
        if (out == undefined) {
          out = [];
        }
        if (Array.isArray(obj)) {
          obj.forEach(function(o) {
            if (o[key] == value) {
              out.push(o);
            } else if (o.contents) {
              searchJSON(o.contents, key, value, out);
            }
          });
        }

        return out;
      }

      /* IMPORT/EXPORT SKETCHES */

      function exportJSON(jsonData, jsonFilename) {
        const filename = jsonFilename;
        const jsonStr = JSON.stringify(jsonData, undefined, 2);

        let element = document.createElement("a");
        element.setAttribute(
          "href",
          "data:text/plain;charset=utf-8," + encodeURIComponent(jsonStr)
        );
        element.setAttribute("download", filename);

        element.style.display = "none";
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }

      // export single sketch to JSON
      function exportSketch(sketch) {
        let jsonExport = {};
        jsonExport.sketches = [];
        jsonExport.sketches.push({
          sketchName: sketch,
          sketchCode: localStorage.getItem(sketch)
        });
        exportJSON(jsonExport, "P5L_" + sketch + "_" + timeStamp() + ".json");
        if (settings.debugMode) {
          console.log(jsonExport);
        }
      }

      // export folder[s] w/ sketches to JSON
      function exportFolder(folder) {
        let folderObj = searchJSON(settings.sketches, "name", folder);
        let tempSketches = {};
        tempSketches.version = settings.version;
        tempSketches.revision = settings.revision;
        tempSketches.structure = folderObj;
        tempSketches.sketches = [];
        listSketches(folderObj).forEach(function(sketch) {
          if (localStorage.hasOwnProperty(sketch)) {
            tempSketches.sketches.push({
              sketchName: sketch,
              sketchCode: localStorage.getItem(sketch)
            });
          }
        });
        exportJSON(
          tempSketches,
          "P5L_FOLDER_" + folder + "_" + timeStamp() + ".json"
        );
      }

      // export all sketches to JSON
      function exportAllSketches() {
        let tempSketches = {};
        tempSketches.version = settings.version;
        tempSketches.structure = settings.sketches;
        tempSketches.revision = settings.revision;
        tempSketches.sketches = [];
        listSketches(settings.sketches).forEach(function(sketch) {
          if (localStorage.hasOwnProperty(sketch)) {
            tempSketches.sketches.push({
              sketchName: sketch,
              sketchCode: localStorage.getItem(sketch)
            });
          }
        });
        exportJSON(tempSketches, "P5L_SKETCHES_" + timeStamp() + ".json");
      }

      function listSketches(obj) {
        return findValues(obj, "type", "sketch", "name");
      }

      function findValues(obj, key, filter, saveKey) {
        return findValuesHelper(obj, key, filter, saveKey, []);
      }

      function findValuesHelper(obj, key, filter, saveKey, list) {
        if (!obj) return list;
        if (obj instanceof Array) {
          for (let i in obj) {
            list = list.concat(
              findValuesHelper(obj[i], key, filter, saveKey, [])
            );
          }
          return list;
        }
        if (obj[key] && obj[key] == filter) list.push(obj[saveKey]);

        if (typeof obj == "object" && obj !== null) {
          let children = Object.keys(obj);
          if (children.length > 0) {
            for (let i = 0; i < children.length; i++) {
              list = list.concat(
                findValuesHelper(obj[children[i]], key, filter, saveKey, [])
              );
            }
          }
        }
        return list;
      }

      // DRAG + DROP
      var divDrop = document.getElementById("p5-drop");
      var myDropzone = new Dropzone(document.body, {
        autoProcessQueue: false,
        url: "/data", // unused but needed for URL expectation
        acceptedFiles: ".json",
        init: function() {
          this.on("addedfile", function(file, responseText) {
            importSketches(myDropzone.files);
            divDrop.style.display = "none";
            myDropzone.files = []; // clear list
          });
          this.on("dragenter", function(file, responseText) {
            if (event.dataTransfer.dropEffect != "move") {
              divDrop.style.display = "block";
            }
          });
          this.on("dragleave", function(file, responseText) {
            divDrop.style.display = "none";
          });
          this.on("drop", function(file, responseText) {
            divDrop.style.display = "none";
          });
          this.on("dragover", function(file, responseText) {
            // event.preventDefault();
            // console.log(event.dataTransfer.dropEffect);
            if (event.dataTransfer.dropEffect != "move") {
              divDrop.style.display = "block";
            }
          });
          this.on("error", function(file, responseText) {
            vex.dialog.alert({
              unsafeMessage:
                "Error importing... <br>Only P5LIVE exports are accepted."
            });
            myDropzone.files = []; // clear list
          });
        }
      });

      // import sketches from JSON
      function importSketches(data) {
        for (let i = 0; i < data.length; i++) {
          let reader = new FileReader();
          reader.onload = function(data) {
            let jsonObj = JSON.parse(data.target.result);
            let jsonObjList = JSON.parse(data.target.result);
            if (jsonObj.hasOwnProperty("structure")) {
              let jsonStructureSorted = jsonObj.structure.reverse();

              let jsonStructureNormal = jsonObjList.structure;
              let count = (
                JSON.stringify(jsonObjList.structure).match(/name/g) || []
              ).length;
              if (
                searchJSON(jsonObjList.structure, "name", "demos").length > 0
              ) {
                count -= searchJSON(settings.sketches, "name", "demos")[0]
                  .contents.length;
              }
              let importData =
                "Import the following (" + count + ") items?<br>";
              let importDupFound = false;
              for (let key in jsonStructureNormal) {
                if (
                  searchSketches(
                    jsonStructureNormal[key].name,
                    settings.sketches &&
                      jsonStructureNormal[key].name.toLowerCase() != "demos"
                  )
                ) {
                  importDupFound = true;
                }
              }
              if (importDupFound) {
                importData +=
                  '<span style="font-size:10pt;"><span class="importdump-dup">Duplicates</span> given a unique _timestamp</span><br>';
              }
              importData += '<div id="importdump">';
              importData += recursiveImportCheck(jsonStructureNormal, "", "");
              importData += "</div>";

              // first confirm importing of whole structure/sketches
              vex.dialog.confirm({
                unsafeMessage: importData,
                callback: function(value) {
                  if (value) {
                    jsonStructureSorted.forEach(function(jsonItem) {
                      if (
                        jsonItem.type == "folder" &&
                        (jsonItem.name.toLowerCase() != "demos" ||
                          searchJSON(settings.sketches, "name", "demos")
                            .length == 0)
                      ) {
                        // foreach folder/sketch check duplicates and give unique names

                        // each base folder
                        if (searchSketches(jsonItem.name, settings.sketches)) {
                          jsonItem.name += "_" + timeStamp(); //versionCheck(jsonItem.name);
                        }

                        // each recursive sketch/folder within
                        recursiveNamecheck(jsonItem.contents, jsonObj.sketches);

                        // add structure to top of sketches list
                        settings.sketches.unshift({
                          type: "folder",
                          name: jsonItem.name,
                          toggle: jsonItem.toggle,
                          contents: jsonItem.contents
                        });
                      } else if (jsonItem.type == "sketch") {
                        settings.sketches.unshift({
                          type: "sketch",
                          name: jsonItem.name
                        });
                      }
                    });
                    updateSettings();
                    initSortable();
                    //updateSketches();

                    // import structure as folder..
                    parseSketches(jsonObj);
                  }
                }
              });
            } else {
              // import single sketch w/o confirm dialog
              checkDupSketches(jsonObj, "sketchName");
              parseSketches(jsonObj);
            }
          };
          reader.readAsText(data[i]);
        }
      }

      function recursiveImportCheck(objStructure, level, outputData) {
        // obj
        for (let k in objStructure) {
          let ric = objStructure[k];
          let ricDup = "";

          if (searchSketches(ric.name, settings.sketches)) {
            ricDup = 'class="importdump-dup"';
          }

          // if sketch, update sketches name too
          if (objStructure[k].type == "sketch") {
            outputData +=
              level +
              iconFileLines +
              "<span " +
              ricDup +
              ">" +
              ric.name +
              "</span><br>";
          }

          // if folder, recurse deeper
          if (ric.type == "folder" && ric.name != "demos") {
            outputData +=
              level +
              iconFolderEmpty +
              "<span " +
              ricDup +
              ">" +
              ric.name +
              "</span><br>";
            outputData = recursiveImportCheck(
              ric.contents,
              "&nbsp;&nbsp;" + level,
              outputData
            );
          }
        }
        return outputData;
      }

      // recursively check for duplicate names when importing
      function recursiveNamecheck(objStructure, objSketches) {
        // obj
        for (let k in objStructure) {
          let rnc = objStructure[k];
          let rncDup = false;
          let rncPName = rnc.name;

          // if duplicate, give unique name
          if (searchSketches(rnc.name, settings.sketches)) {
            // && rnc.type == 'sketch'
            rnc.name += "_" + timeStamp(); // versionCheck(rnc.name);
            fixNamecheck(objSketches, rncPName, rnc.name);
          }

          // if folder, recurse deeper
          if (rnc.type == "folder") {
            recursiveNamecheck(rnc.contents, objSketches);
          }
        }
      }

      // fix any duplicate names
      function fixNamecheck(obj, oldName, newName) {
        for (let i = 0; i < obj.length; i++) {
          if (obj[i]["sketchName"] === oldName) {
            obj[i]["sketchName"] = newName;
          }
        }
      }

      // fix any duplicates on single file imports
      function checkDupSketches(obj, keyName) {
        let jsonSketches = obj.sketches;
        for (let i = 0; i < jsonSketches.length; i++) {
          if (searchSketches(jsonSketches[i][keyName], settings.sketches)) {
            jsonSketches[i][keyName] = versionCheck(jsonSketches[i][keyName]);
          }
        }
      }

      // recursively check folder containing sketch
      function recursiveFolderExpand(objStructure, sketch, curFolder) {
        // obj
        for (let key in objStructure) {
          // sketch, update sketches name too
          if (
            objStructure[key].type == "sketch" &&
            objStructure[key].name == sketch
          ) {
            if (curFolder != "" && curFolder.toggle != "expand") {
              curFolder.toggle = "expand";
              initSortable();
            }
          }

          // if folder, recurse deeper
          if (objStructure[key].type == "folder") {
            recursiveFolderExpand(
              objStructure[key].contents,
              sketch,
              objStructure[key]
            );
          }
        }
      }

      // load demos
      function loadDemos() {
        let demosPath =
          "includes/demos/P5L_demos_20191103232335.json?" + currentRevision;
        let request = new XMLHttpRequest();
        request.open("GET", demosPath, false);
        request.send();
        let jsonObj = JSON.parse(request.responseText);
        recursiveNamecheck(jsonObj.structure, jsonObj.sketches);

        //add structure to top of sketches list
        settings.sketches.push({
          type: "folder",
          name: jsonObj.structure[0].name,
          toggle: jsonObj.structure[0].toggle,
          contents: jsonObj.structure[0].contents
        });

        updateSettings();
        initSortable();

        parseSketches(jsonObj);
      }

      function refreshDemos() {
        window.setTimeout(function() {
          removeItemProcess("demos");
          window.setTimeout(function() {
            loadDemos();
          }, 200);
        }, 200);
      }

      function parseSketches(jsonObj) {
        let jsonSketches = jsonObj.sketches.reverse();
        for (let i = 0; i < jsonSketches.length; i++) {
          let sketchName = jsonSketches[i].sketchName;
          let sketchCode = jsonSketches[i].sketchCode;
          localStorage.setItem(sketchName, sketchCode);

          // add to settings if doesn't exist
          if (!searchSketches(sketchName, settings.sketches)) {
            settings.sketches.unshift({ type: "sketch", name: sketchName });
          }

          if (sketchName == settings.fileName) {
            loadSketch(sketchName);
          }
        }
        updateSketches();
      }

      /* MENU » SKETCHES */

      function legacySettings() {
        if (typeof settings.sketches[0] != "object") {
          let order = settings.sketches;
          let newOrder = [];
          let oldDemos = [
            "aboutsketch",
            "bwEllipse",
            "easeFunction",
            "sinStrings",
            "wanderingWorm",
            "audioAnalysis",
            "webgl_sphereBox",
            "textToPoints",
            "basel.codes",
            "this is a really long name"
          ];
          order.forEach(function(o) {
            if (!oldDemos.includes(o)) {
              newOrder.push({ name: o, type: "sketch" });
            }
          });
          settings.sketches = newOrder;
          updateSettings();
        }

        if (
          searchJSON(settings.sketches, "name", "demos").length == 0 ||
          settings.revision < currentRevision
        ) {
          loadDemos();
        }
      }

      function getOrder() {
        if (menuSketches.childNodes.length > 0) {
          const traverse = function(dir, result = []) {
            dir.childNodes.forEach(node => {
              let nodeName = "";
              if (
                node.dataset != undefined &&
                (node.dataset.type == "folder" || node.dataset.type == "sketch")
              ) {
                nodeName = node.dataset.id;
              } else {
                return traverse(node, result);
              }

              const nodeStats = { name: nodeName };

              if (node.dataset.type == "folder") {
                nodeStats.type = "folder";
                nodeStats.toggle = node.dataset.toggle;
                nodeStats.contents = [];
                result.push(nodeStats);
                return traverse(node, nodeStats.contents);
              }
              if (node.dataset.type == "sketch") {
                nodeStats.type = "sketch";
                result.push(nodeStats);
              }
            });
            return result;
          };

          let recursiveSortable = traverse(menuSketches);
          settings.sketches = recursiveSortable;

          updateSettings();
          initSortable();
        }
      }

      // initialize sortable
      function initSortable() {
        if (
          settings.sketches.length > 0 &&
          typeof settings.sketches[0] === "object"
        ) {
          let selSelected = false;
          //let curFolder = "";
          let htmlStr =
            '<li class="sortable-placeholder" data-type="buffer"></li>' +
            recurse(settings.sketches, "");
          menuSketches.innerHTML =
            htmlStr +
            '<li class="sortable-placeholder" data-type="buffer"></li>';
          initFolders(menuSketches);

          function recurse(data, curFolder) {
            let html =
              '<li class="sortable-placeholder" data-type="buffer"></li>';
            for (let key in data) {
              let d = data[key];
              let marq = "";
              let demoClass = " drag-item ";
              let demoFolder = "";
              if (d.name.length > 15) {
                marq = "marq";
              }
              if (d.type == "sketch") {
                let selClass = "";
                let navSketch =
                  "onmouseenter=\"showNav(this, '" +
                  d.name +
                  "', 'sketch');\" onmouseleave=\"hideNav(this);\"";
                if (curFolder == "demos") {
                  if (demosLocked) {
                    navSketch = "";
                    demoClass = " demo";
                  }
                }
                if (d.name == settings.fileName) {
                  selClass = "sketch-selected";
                  selSelected = true;
                }
                html +=
                  '<li class="item-sketch menu-sketch-holder ' +
                  selClass +
                  demoClass +
                  '" data-type="sketch" data-id="' +
                  d.name +
                  '" ' +
                  navSketch +
                  '><div class="menu-sketch-nav"></div><div class="menu-sketch ' +
                  marq +
                  '" onclick="loadSketch(\'' +
                  d.name +
                  "')\">" +
                  iconFileLines +
                  "" +
                  d.name +
                  "</div></li>";
              } else if (d.type == "folder") {
                curFolder = d.name;
                let icon = iconFolderExpand;
                let navFolder =
                  "onmouseenter=\"showNav(this, '" +
                  d.name +
                  "', 'folder');\" onmouseleave=\"hideNav(this);\"";
                if (curFolder == "demos" && demosLocked) {
                  navFolder =
                    "onmouseenter=\"showNav(this, '" +
                    d.name +
                    "', 'demos');\" onmouseleave=\"hideNav(this);\"";
                  demoClass = " demo";
                  demoFolder = 'id="demofolder"';
                }
                if (
                  settings.cocoding.active &&
                  curFolder == settings.cocoding.namespace
                ) {
                  navFolder = "";
                }
                if (d.toggle == "expand") {
                  icon = iconFolderCollapse;
                }

                if (d.contents.length == 0) {
                  icon = iconFolderEmpty;
                  d.toggle = "collapse";
                }
                html +=
                  "<ul " +
                  demoFolder +
                  ' class="item-folder ' +
                  d.toggle +
                  demoClass +
                  '" data-type="folder" data-id="' +
                  d.name +
                  '" data-toggle="' +
                  d.toggle +
                  '" ondragover="dragOver(this)" >';
                html +=
                  '<div class="foldertitle" ' +
                  navFolder +
                  '><div class="menu-sketch-nav"></div><div onclick="toggle(this);" class="menu-folder ' +
                  marq +
                  '">' +
                  icon +
                  "" +
                  d.name +
                  "</div></div> ";
                html += recurse(d.contents, curFolder);
                html += "</ul>";
                curFolder = "";
              }
            }
            html += "";
            return html;
          }

          // main folder
          new Sortable(menuSketches, options);

          // all sub-folders
          document.querySelectorAll(".drag-item").forEach(s => {
            new Sortable(s, options);
          });

          if (document.getElementById("demofolder") != undefined) {
            new Sortable(demofolder, {
              group: { name: "demos", pull: false, put: false },
              filter: ".demo"
            });
          }

          if (settings.refresh) {
            settings.refresh = false;
            refreshDemos();
          }
          loadTippy();
        }
      }

      function dragOver(elm) {
        elm.style.minHeight = "40px";
      }

      // load sortable, restore expanded/collapsed
      function initFolders(elm) {
        elm.childNodes.forEach(function(node) {
          if (node.dataset != undefined && node.dataset.type == "folder") {
            node.style.display = "block";
            if (node.dataset.toggle == "expand") {
              node.childNodes.forEach(k => {
                if (k.tagName == "UL" || k.tagName == "LI") {
                  k.style.display = "block";
                  if (
                    k.dataset.type == "folder" &&
                    k.dataset.toggle == "expand"
                  ) {
                    initFolders(k);
                  }
                }
              });
            }
          }
        });
      }

      // expand/collapse folders
      function toggle(elm) {
        let divFolder = elm.parentNode.parentNode;
        if (divFolder.dataset.toggle == "expand") {
          divFolder.dataset.toggle = "collapse";
          elm.innerHTML = iconFolderExpand;
          divFolder.childNodes.forEach(k => {
            if (k.tagName == "UL" || k.tagName == "LI")
              k.style.display = "none";
          });
        } else {
          divFolder.dataset.toggle = "expand";
          elm.innerHTML = iconFolderCollapse;
          divFolder.childNodes.forEach(k => {
            if (k.tagName == "UL" || k.tagName == "LI")
              k.style.display = "block";
          });
        }
        getOrder();
      }

      function showNav(elm, elmID, elmType) {
        elm.style.width = "calc(100%-78px)";
        if (elmType == "folder") {
          elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML =
            '<a class="menu-sketch-button tippy" onclick="renameItem(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Rename">' +
            iconRename +
            '</a><a class="menu-sketch-button tippy" onclick="exportFolder(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Export">' +
            iconExport +
            '</a><a class="menu-sketch-button tippy" onclick="removeItem(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Remove">' +
            iconRemove +
            "</a>";
        } else if (elmType == "sketch") {
          elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML =
            '<a class="menu-sketch-button tippy" onclick="renameItem(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Rename">' +
            iconRename +
            '</a><a class="menu-sketch-button tippy" onclick="exportSketch(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Export">' +
            iconExport +
            '</a><a class="menu-sketch-button tippy" onclick="removeItem(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Remove">' +
            iconRemove +
            "</a>";
        } else if (elmType == "demos") {
          elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML =
            '<a class="menu-sketch-button tippy" onclick="refreshDemos(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Refresh">' +
            iconRefresh +
            "</a>";
        } else if (elmType == "user") {
          elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML =
            '<a class="menu-sketch-button tippy" onclick="toggleEdit(\'' +
            elmID +
            "', '" +
            elmType +
            '\')" data-title="Refresh">' +
            iconToggleLeft +
            "</a>";
        } else if (elmType == "self") {
          let reqClass = "";
          if (settings.cocoding.request) {
            reqClass = " req ";
          }
          elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML =
            '<a id="request-' +
            elmID +
            '" class="menu-sketch-button tippy ' +
            reqClass +
            '" onclick="cocode.editRequest(\'' +
            elmID +
            '\')" data-title="Request Edit">' +
            iconEdit +
            "</a>";
        }

        loadTippy();
      }

      function hideNav(elm) {
        elm.getElementsByClassName("menu-sketch-nav")[0].innerHTML = "";
        elm.style.width = "calc(100%-5px)";
      }

      function addFolder(folderName) {
        let newID = "folder " + Math.floor(Math.random() * 99);
        if (folderName != undefined) {
          newID = folderName;
        }
        let newFolder =
          '<ul class="item-folder" ondragover="dragOver(this)" data-type="folder" data-toggle="expand" data-id="' +
          newID +
          '"><a onclick="toggle(this);">' +
          iconFolderEmpty +
          '</a> Folder<div class="sketches" style="display:block" ></div></ul>';
        let tempHTML = menuSketches.innerHTML;
        menuSketches.innerHTML = newFolder + tempHTML;
        getOrder();
        if (folderName == undefined) {
          renameItem(newID, "folder");
        }
      }

      // rename sketch/folder
      function renameItem(itemName, itemType) {
        vex.dialog.prompt({
          message: "Rename:",
          value: itemName, // placeholder
          callback: function(value) {
            if (value) {
              let newName = value.replace(/["']/g, "");
              if (newName != "" && newName != itemName) {
                let sketchesFlat = JSON.stringify(settings.sketches);
                if (sketchesFlat.indexOf('"' + itemName + '"') > -1) {
                  if (sketchesFlat.indexOf('"' + newName + '"') == -1) {
                    let sketchesFixed = sketchesFlat.replace(
                      '"' + itemName + '"',
                      '"' + newName + '"'
                    );
                    settings.sketches = JSON.parse(sketchesFixed);
                  } else {
                    vex.dialog.alert({
                      message:
                        '"' + newName + '" already exists. Pick a new name',
                      callback: function() {
                        renameItem(itemName, itemType);
                      }
                    });
                    return false;
                  }
                }

                updateSettings();
                initSortable();
                if (itemType == "sketch") {
                  localStorage.setItem(newName, localStorage[itemName]);
                  localStorage.removeItem(itemName);
                  if (settings.fileName == itemName) {
                    settings.fileName = newName;
                    if (!settings.cocoding.active) {
                      setTimeout(function() {
                        loadSketch(newName);
                      }, 100);
                    }
                  }
                }
              }
            }
          },
          afterOpen: function() {
            document
              .getElementsByClassName("vex-dialog-prompt-input")[0]
              .select();
          }
        });
      }

      // taking out the trash
      function removeItem(dataID, elmType) {
        vex.dialog.confirm({
          message: "Are you sure you want to delete: " + dataID + " ?",
          callback: function(value) {
            if (value) {
              removeItemProcess(dataID);
            }
          }
        });
      }

      function removeItemProcess(dataID) {
        let selElm = document.querySelectorAll('[data-id="' + dataID + '"]')[0];
        selElm.querySelectorAll("[data-id]").forEach(function(k) {
          localStorage.removeItem(k.dataset.id);
          k.remove();
        });

        // catch active sketch in trashed folder
        // let dataIDType = searchJSON(settings.sketches, 'name', dataID)[0];
        // if(dataIDType.type === 'folder'){
        // 	for(let i=0; i < dataIDType.contents.length; i++){
        // 		if(settings.fileName === dataIDType.contents[i].name){
        // 			sketchInFolder = true;
        // 		}
        // 	}
        // }

        localStorage.removeItem(dataID);
        selElm.remove();

        getOrder();

        let sketchIsGone = false;
        if (!searchSketches(settings.fileName, settings.sketches)) {
          sketchIsGone = true;
        }

        if (
          (dataID === settings.fileName || sketchIsGone) &&
          !settings.cocoding.active
        ) {
          // *** issue if trashing folder containing active sketch...
          loadSketch(loadLatest());
        }
      }

      /* EDITOR KEY-CMDS */

      let map = [];
      window.onkeydown = function(event) {
        map[event.keyCode] = event.type == "keydown";

        if (map[16] && map[17]) {
          if (event.keyCode == 13) {
            forceRecompile = true;
            clearTimeout(errorTimer);
            recompile(true);
          } else {
            addSnippet(event.key);
          }
          event.preventDefault();
        } else if (!map[16] && map[17]) {
          // check !shift and √control
          if (event.keyCode == 69) {
            // e = editor toggle
            editorToggle();
            event.preventDefault();
          } else if (event.keyCode == 67) {
            // c = editor toggle
            cursorToggle();
            event.preventDefault();
          } else if (event.keyCode == 79) {
            // o = open
            switchSketch();
            event.preventDefault();
          } else if (event.keyCode == 77) {
            // m = menu
            menuToggle();
            event.preventDefault();
          } else if (event.keyCode == 13) {
            // enter = recompile
            forceRecompile = true;
            clearTimeout(errorTimer);
            recompile();
            event.preventDefault();
          } else if (event.keyCode == 80) {
            // p = pause
            pauseSketch();
            event.preventDefault();
          } else if (event.keyCode == 78) {
            // n = new
            loadDefault();
            event.preventDefault();
          } else if (event.keyCode == 83) {
            // s = save PNG
            savePNG();
            event.preventDefault();
          } else if (event.keyCode == 82) {
            // r = ref
            if (refHolder.style.display == "block") {
              closeRef();
            } else {
              showRef();
            }
            event.preventDefault();
          } else if (event.keyCode >= 48 && event.keyCode <= 57) {
            // 	0-9 = preset sketches
            let keySketch = event.keyCode - 49;
            if (keySketch == -1) {
              keySketch = 9;
            }
            loadSketch(listSketches(settings.sketches)[keySketch]); // FIX PRESETS
            event.preventDefault();
          } else if (event.key == "i") {
            pop720(); // IG window size
          }
        }

        if (event.keyCode == 8) {
          // DELETE = prevent back navigation in FF
          let eTarget = event.target.tagName.toLowerCase();
          if (!p5code.focus() && eTarget != "input" && eTarget != "textarea") {
            event.preventDefault();
          }
        }
      };

      window.onkeyup = function(event) {
        map[event.keyCode] = event.type == "keydown";
      };

      // Editor Interactions
      p5code.onkeydown = function(event) {
        map[event.keyCode] = event.type == "keydown";

        pLen = editor.getValue().length; // len of editor
        if (settings.debugMode) {
          console.log(event);
        }

        if (!map[16] && map[17]) {
          // check for !shift + √control
          if (event.key == "+" || event.key == "=") {
            // up arrow = bigger font
            fontSizeAdjust(parseFloat(settings.fontSize) + 0.25);
            event.preventDefault();
          } else if (event.key == "-") {
            // down arrow = smaller font
            fontSizeAdjust(parseFloat(settings.fontSize) - 0.25);
            event.preventDefault();
          } else if (event.keyCode == 65) {
            // a = auto compile
            autoCompileToggle();
            event.preventDefault();
          } else if (event.keyCode == 84) {
            // t = tidy code
            tidyCode();
            event.preventDefault();
          }
        }
      };

      p5code.onkeyup = function(event) {
        map[event.keyCode] = event.type == "keydown";
        if (!settings.cocoding.active) {
          localStorage[settings.fileName] = editor.getValue();
        }
        // checkErrors();	// ** maybe turn back on>?
      };

      function checkErrors() {
        clearTimeout(errorTimer);
        errorTimer = setTimeout(function() {
          checkErrorsWorker();
        }, settings.compileTimer);
      }

      function checkErrorsWorker() {
        let annos = editor.getSession().getAnnotations();

        if (settings.debugMode) {
          console.log(annos);
        }
        let errorsFound = false;
        for (let i = 0; i < annos.length; i++) {
          if (annos[i].type == "error") {
            errorsFound = true;
          }
        }
        if (errorsFound) {
          validCode = false;
          checkErrors();
        } else {
          clearTimeout(errorTimer);
          validCode = true;
          if (settings.autoCompile) {
            recompile();
          }
        }
        if (settings.debugMode) {
          console.log("validCode: " + validCode);
        }
      }

      // prevent lost work in default
      window.addEventListener("beforeunload", function(e) {
        if (settings.fileName == "default") {
          let confirmationMessage = "\o/";
          (e || window.event).returnValue = confirmationMessage; //Gecko + IE
          return confirmationMessage; //Webkit, Safari, Chrome
        }
      });

      function consoleMessage(msg, timeDelay) {
        p5console.value = msg;
        p5console.style.display = "block";
        if (timeDelay != undefined && timeDelay != 0) {
          if (consoleTimer != undefined) {
            clearTimeout(consoleTimer);
          }
          consoleTimer = setTimeout(consoleHide, timeDelay * 1000);
        }
      }

      function consoleHide() {
        if (consoleTimer != undefined) {
          clearTimeout(consoleTimer);
        }
        p5console.value = "";
        p5console.style.display = "none";
      }

      /* COMPILE CODE */

      function recompile(force) {
        let currline = editor.getSelectionRange().start.row;
        let currCode = editor.session.getLine(currline);
        curPos = editor.getCursorPosition();

        // catch missing {}'s
        let codeNoComments = editor
          .getValue()
          .replace(/\/\*[\s\S]*?\*\/|([^:]|^)\/\/.*$/gm, (_, g1, g2) =>
            Array(_.split("\n").length).join("\n")
          );

        let cbCount = {
          l: (codeNoComments.match(/\{/g) || []).length,
          r: (codeNoComments.match(/\}/g) || []).length
        };
        if (cbCount.l == 0 || cbCount.l != cbCount.r) {
          let missingBracket = "'}'";
          if (cbCount.l < cbCount.r) {
            missingBracket = "'{'";
          }
          consoleMessage(
            "Missing " + missingBracket + ". Find mistake then recompile.",
            0
          );
          return false;
        } else {
          consoleHide();
        }

        if (
          (currCode.search("for") == -1 && currCode.search("while") == -1) ||
          forceRecompile
        ) {
          if (validCode) {
            if (editor.getValue().indexOf("function setup()") != -1) {
              // check setup exists
              // buildSketch(); //
              updateBackground();
              if (settings.cocoding.active) {
                if (settings.cocoding.sync) {
                  if (settings.cocoding.level == "admin") {
                    buildSketch(force); //
                    cocode.recompile(force);
                  }
                } else {
                  buildSketch(force); //
                }
              } else {
                buildSketch(force); //
              }

              // if(settings.cocoding.active && settings.cocoding.sync && settings.cocoding.level == 'admin'){
              // 	buildSketch(); //
              // 	updateBackground();
              // 	cocode.recompile();
              // }else if(){
              // 	buildSketch(); //
              // 	updateBackground();
              // }
            }
          }
        }
        forceRecompile = false;
      }

      // new technique to avoid accessing p5live_sketch.html sooo many times!
      function buildSketch(force) {
        // softCompile
        if (force == undefined && sketchLoaded) {
          // technique to only update draw if code changed there (= continous background!)
          let rawLines = editor.session.getLines(0, editor.session.getLength());
          let drawPos = []; //{};
          let drawPosSel = -1;
          let countBrackets = false;
          let braces = 0;
          let softFunction = false;
          let softClass = false;

          // replace single + multiline comments with \n to avoid processing + keep line numbers same
          let codeNoComments = editor
            .getValue()
            .replace(/\/\*[\s\S]*?\*\/|([^:]|^)\/\/.*$/gm, (_, g1, g2) =>
              Array(_.split("\n").length).join("\n")
            );

          let allLines = codeNoComments.split("\n");

          // test purging of comments
          // let offLines = 6;
          // console.log(rawLines[offLines]);
          // console.log(allLines[offLines]);

          // extract all functions and their line number
          for (let i = 0; i < allLines.length; i++) {
            // catch function or class
            if (allLines[i].includes("function ") && !countBrackets) {
              countBrackets = true;
              let functionName = allLines[i]
                .match(/function ([\w\d]*)\(/)[1]
                .trim();
              drawPos.push({ type: "function", name: functionName, start: i });
            } else if (allLines[i].includes("class ") && !countBrackets) {
              countBrackets = true;
              let className = allLines[i].match(/class\s([\w\d]*)/)[1].trim();
              drawPos.push({ type: "class", name: className, start: i });
            }

            // count {} and mark where class/function ends
            if (countBrackets) {
              if (allLines[i].includes("{")) {
                braces += (allLines[i].match(/{/g) || []).length;
              }
              if (allLines[i].includes("}")) {
                braces -= (allLines[i].match(/}/g) || []).length;
                if (braces == 0) {
                  drawPos[drawPos.length - 1].end = i;
                  countBrackets = false;
                }
              }
            }
          }

          // check all changed positions + if custom function
          let funName = "";
          for (let i = 0; i < drawPos.length; i++) {
            for (let j = 0; j < curPositions.length; j++) {
              let cPos = curPositions[j];
              if (cPos.row >= drawPos[i].start && cPos.row <= drawPos[i].end) {
                // console.log(drawPos[i].name); // debug where change occured
                if (
                  drawPos[i].name != "setup" &&
                  drawPos[i].name != "preload" &&
                  drawPos[i].type == "function"
                ) {
                  softFunction = true;
                  drawPosSel = i;
                  funName = drawPos[i].name;
                } else if (drawPos[i].type == "class") {
                  softClass = true;
                  drawPosSel = i;
                }
              }
            }
          }

          // if custom function, grab where it's used
          let functionPos = [];
          for (let j = 0; j < drawPos.length; j++) {
            if (funName == drawPos[j].name) {
              // find lines where drawPos[i].name sits
              for (let i = 0; i < allLines.length; i++) {
                if (allLines[i].includes(drawPos[j].name + "(")) {
                  functionPos.push(i);
                }
              }
            }
          }

          // catch custom functions in preload + setup
          for (let i = 0; i < functionPos.length; i++) {
            for (let j = 0; j < curPositions.length; j++) {
              let fPos = functionPos[j];
              if (fPos >= drawPos[i].start && fPos <= drawPos[i].end) {
                // console.log(drawPos[i].name); // debug where chage occured
                if (
                  drawPos[i].name == "setup" ||
                  drawPos[i].name == "preload"
                ) {
                  // && !settings.cocoding.active
                  softFunction = false;
                }
              }
            }
          }

          // if possible, only overwrite function/class for softCompile
          if (softClass || softFunction) {
            softCompile(
              drawPos[drawPosSel].type,
              drawPos[drawPosSel].name,
              drawPos[drawPosSel].start,
              drawPos[drawPosSel].end
            );
            curPositions = [];
            return false; // prevent complete rebuild
          }
        }

        // hardCompile
        sketchLoaded = false;
        let el = p5frameTemplate.cloneNode(true);
        let iFrameBody = el.getElementsByTagName("head")[0]; //el.document.getElementsByTagName('body')[0];

        // 追加
        let sc = document.createElement("script");
        sc.type = "text/javascript";
        sc.innerHTML = "const __myCache={};";
        iFrameBody.appendChild(sc);
        // 追加ここまで

        // load scripts remote vs local (*** add custom options here)
        for (let i = 0; i < includeScripts.length; i++) {
          let s = document.createElement("script");
          s.type = "text/javascript";
          if (window.location.hostname.includes("teddavis.org")) {
            s.src = includeScripts[i].remote;
          } else {
            s.src = includeScripts[i].local;
            document.title = "P5LIVE – OFFLINE";
          }
          iFrameBody.appendChild(s);
        }

        // check loadScripts;
        let sketchTest = editor.getValue();
        sketchTest = sketchTest.replace(/(?:\r\n|\r|\n|\t)/g, "");
        let sketchLoadScriptsRegEx = /loadScripts\s+=\s+\[(.*["']\])/;
        let sketchLoadScripts = sketchLoadScriptsRegEx.exec(sketchTest);
        if (sketchLoadScripts != undefined) {
          sketchLoadScripts = sketchLoadScripts[1]
            .replace(/["']/g, "")
            .replace(/[' '|\]]/g, "")
            .split(",");
          for (let i = 0; i < sketchLoadScripts.length; i++) {
            let s = document.createElement("script");
            s.type = "text/javascript";
            s.src = sketchLoadScripts[i];
            iFrameBody.appendChild(s);
          }
        }

        // load sketch
        let s = document.createElement("script");
        s.type = "text/javascript";
        let sketchCode = editor.getValue();
        let updateVars =
          "\npmouseX=" +
          p5vars.mouseX +
          ";\npmouseY=" +
          p5vars.mouseY +
          ";\nmouseX=" +
          p5vars.mouseX +
          ";\nmouseY=" +
          p5vars.mouseY +
          ";\nframeCount=" +
          p5vars.frameCount +
          ";\n";
        let codeSetup = addCode(sketchCode, updateVars, "setup", "bottom");

        s.innerHTML = codeSetup + p5custom.value + "new p5(); sketchStatus();";
        if (!settings.safeMode) {
          iFrameBody.appendChild(s);
        }

        // set dynamic html as iframe srcdoc
        p5frame.srcdoc = el.innerHTML;
        curPositions = [];
      }

      // softCompile function or class changes
      function softCompile(codeType, codeName, codeStart, codeEnd) {
        let curCodeTemp = "";
        if (codeType == "function") {
          curCodeTemp = editor.session.getLines(codeStart, codeEnd).join("\n");
        } else if (codeType == "class") {
          curCodeTemp =
            codeName +
            " = class {" +
            editor.session.getLines(codeStart + 1, codeEnd).join("\n");
        }
        let s = document.createElement("script");
        s.type = "text/javascript";
        s.innerHTML = curCodeTemp;
        p5f.document.head.appendChild(s);
      }

      function updateBackground() {
        let bgReg = /background\(([^)]+)\)/;
        let nonComments = editor.getValue();
        nonComments = nonComments
          .replace(/\s*\/\/.*\n/g, "\n")
          .replace(/\s*\/\*[\s\S]*?\*\//g, "");
        let bgMatches = bgReg.exec(nonComments);
        if (bgMatches != null) {
          let newBG = "";
          if (bgMatches[1].includes("#")) {
            newBG = bgMatches[1].replace(/["']/g, "");
          } else {
            let cols = bgMatches[1].split(",");
            if (cols.length > 2) {
              newBG = rgb2hex(cols[0].trim(), cols[1].trim(), cols[2].trim());
            } else {
              newBG = rgb2hex(cols[0].trim(), cols[0].trim(), cols[0].trim());
            }
          }
          // document.body.style.background = newBG;
          p5frame.style.background = newBG;
        }
      }

      function rgb2hex(red, green, blue) {
        let rgb = blue | (green << 8) | (red << 16);
        return "#" + (0x1000000 + rgb).toString(16).slice(1);
      }

      function loadScripts(elm) {
        if (settings.debugMode) {
          console.log(settings.scripts);
        }
        for (let i = 0; i < settings.scripts.length; i++) {
          elm.appendChild(loadScript(settings.scripts[i]));
        }
      }

      function loadScript(scriptPath) {
        let ps = document.createElement("script");
        ps.type = "text/javascript";
        ps.src = scriptPath;
        return ps;
      }

      function tidyCode() {
        let tempCode = js_beautify(editor.getValue(), beautifyOptions);
        editor.setValue(tempCode, 1);
      }

      /* SNIPPETS */
      function loadSnippets() {
        let snippetsPath =
          "includes/demos/P5L_snippets_20191214.json?" + currentRevision;
        let request = new XMLHttpRequest();
        request.open("GET", snippetsPath, false);
        request.send();
        let jsonObj = JSON.parse(request.responseText);
        snippets = jsonObj.snippets;
        let dropCommands = [];
        let cmds = editor.commands;
        for (let i = 0; i < snippets.length; i++) {
          let snippetKey = snippets[i].key + "";
          let findCommand =
            cmds.commandKeyBinding["ctrl-shift-" + snippetKey.toLowerCase()];
          if (findCommand != undefined) {
            dropCommands.push(findCommand.name);
          }
        }
        editor.commands.removeCommands(dropCommands);
      }

      function addSnippet(loadSnippet) {
        let snippetIndex = snippets
          .map(function(d) {
            return d["key"];
          })
          .indexOf(loadSnippet);
        if (snippetIndex == -1) {
          return false;
        }
        let snippetCode = snippets[snippetIndex].code;
        let addGlobalTop = snippetCode.global.top;
        let addGlobalBottom = snippetCode.global.bottom;
        let addSetup = snippetCode.setup;
        let addDrawTop = snippetCode.draw.top;
        let addDrawBottom = snippetCode.draw.bottom;

        let curCode = editor.getValue();
        let codeGlobalTop = addGlobalTop + "\n" + curCode;
        let codeSetup = addCode(codeGlobalTop, addSetup, "setup", "bottom");
        let codeDrawTop = addCode(codeSetup, addDrawTop, "draw", "top");
        let codeDrawBottom = addCode(
          codeDrawTop,
          addDrawBottom,
          "draw",
          "bottom"
        );
        let codeGlobalBottom = codeDrawBottom + "\n\n" + addGlobalBottom;

        editor.setValue(codeGlobalBottom, 1);
        tidyCode();
      }

      function addCode(codeBase, codeInsert, funName, codePos) {
        let tempCode,
          tempPos = addPosition(codeBase, funName);
        if (codePos === "bottom") {
          tempCode = [
            codeBase.slice(0, tempPos[1]),
            "" + codeInsert + "\n",
            codeBase.slice(tempPos[1])
          ].join("");
        } else if (codePos === "top") {
          tempCode = [
            codeBase.slice(0, tempPos[0]),
            codeInsert + "",
            codeBase.slice(tempPos[0])
          ].join("");
        }
        return tempCode;
      }

      // grab start/end of function, modded for position only
      // https://stackoverflow.com/a/49240267/10885535
      function addPosition(content, functionName) {
        // Find function
        const indexOfFunc = content.indexOf(`function ${functionName}`);

        if (indexOfFunc < 0) {
          return content;
        }

        const openingBrace = content.indexOf("{", indexOfFunc);

        const startPos = openingBrace + 1;
        let endPos = startPos;
        let bracesToBalance = 1;

        while (true) {
          if (content[endPos] === "{") {
            bracesToBalance++;
          } else if (content[endPos] === "}") {
            bracesToBalance--;
            if (bracesToBalance === 0) break;
          }
          endPos++;
        }

        return [startPos, endPos];
      }

      /* SETTINGS TOGGLES */

      // toggle auto-compile
      function autoCompileToggle() {
        settings.autoCompile = !settings.autoCompile;
        autoCompileUpdate();
      }

      function autoCompileUpdate() {
        checkToggle("autoCompile", settings.autoCompile, settingsAutoMode);
        if (settings.autoCompile) {
          settingsCompileTimer.style.display = "block";
        } else {
          settingsCompileTimer.style.display = "none";
        }
      }

      // auto-compile delay on keyup
      function compileTimerChange() {
        settings.compileTimer = settingsCompileTimer.value;
        updateSettings();
      }

      function compileTimerUpdate() {
        for (let i = 0; i < settingsCompileTimer.options.length; i++) {
          let opt = settingsCompileTimer.options[i];
          if (settings.compileTimer == opt.value) {
            settingsCompileTimer.selectedIndex = i;
          }
        }
      }

      // toggle ecorender (pause if focus is lost)
      function ecoRenderToggle() {
        settings.ecoRender = !settings.ecoRender;
        ecoRenderUpdate();
      }

      function ecoRenderUpdate() {
        checkToggle("ecoRender", settings.ecoRender, settingsEcoMode);
      }

      // loop/noLoop on window blur

      window.onblur = function() {
        // deactivate modifier keys
        map[16] = false;
        map[17] = false;

        if (settings.cocoding.active) {
          cocode.socket.emit("status", "blur");
        }
        if (settings.ecoRender && sketchLoaded && !settings.cocoding.sync) {
          if (document.activeElement !== p5frame) {
            p5f.noLoop();
          }
        }
      };

      window.onfocus = function() {
        // deactivate modifier keys
        map[16] = false;
        map[17] = false;

        if (settings.cocoding.active) {
          cocode.socket.emit("status", "focus");
        }
        if (sketchLoaded) {
          p5f.loop();
        }
      };

      // toggle fullscreen (better to use browser native fullscreen)
      function fullscreenToggle() {
        settings.fullscreenMode = !settings.fullscreenMode;
        fullscreenUpdate();
      }

      function fullscreenUpdate() {
        checkToggle(
          "fullscreenMode",
          settings.fullscreenMode,
          settingsFullscreen
        );
        if (settings.fullscreenMode) {
          if (sketchLoaded) {
            openFullscreen();
            editorToggleUpdate();
          }
        } else {
          if (sketchLoaded) {
            closeFullscreen();
          }
        }
      }

      //cursor toggle
      function cursorToggle() {
        settings.canvasCursor = !settings.canvasCursor;
        cursorToggleUpdate();
      }

      function cursorToggleUpdate() {
        checkToggle(
          "canvasCursor",
          settings.canvasCursor,
          settingsCanvasCursor
        );
        if (sketchLoaded) {
          if (!settings.canvasCursor) {
            p5f.noCursor();
            p5frameCover.style.cursor = "none";
            p5frame.style.cursor = "none";
          } else {
            p5f.cursor();
            p5frameCover.style.cursor = "crosshair";
            p5frame.style.cursor = "crosshair";
          }
        }
      }

      //console toggle
      function consoleToggle() {
        settings.console = !settings.console;
        consoleToggleUpdate();
      }

      function consoleToggleUpdate() {
        checkToggle("console", settings.console, settingsConsole);
        if (!settings.console) {
          p5console.style.display = "none";
        } else {
          p5console.style.display = "block";
        }
      }

      //menutab toggle
      function menutabToggle() {
        settings.menutab = !settings.menutab;
        menutabToggleUpdate();
      }

      function menutabToggleUpdate() {
        checkToggle("menutab", settings.menutab, settingsMenutab);
        if (!settings.menutab) {
          menuSwitch.style.display = "none";
        } else {
          menuSwitch.style.display = "block";
        }
      }

      //linenumbers toggle
      function linenumbersToggle() {
        settings.linenumbers = !settings.linenumbers;
        linenumbersUpdate();
      }

      function linenumbersUpdate() {
        checkToggle("linenumbers", settings.linenumbers, settingsLinenumbers);
        if (!settings.linenumbers) {
          editor.setOptions({
            showLineNumbers: false, // false
            showGutter: false // false
          });
        } else {
          editor.setOptions({
            showLineNumbers: true, // false
            showGutter: true // false
          });
        }
      }

      //exportcode toggle
      function exportcodeToggle() {
        settings.exportCode = !settings.exportCode;
        linenumbersUpdate();
      }

      function exportcodeUpdate() {
        checkToggle("exportCode", settings.exportCode, settingsExportcode);
      }

      //BGactive toggle
      function themeBGactiveToggle() {
        settings.themeBGactive = !settings.themeBGactive;
        themeBGactiveToggleUpdate();
      }

      function themeBGactiveToggleUpdate() {
        checkToggle("themeBGactive", settings.themeBGactive, settingsBGactive);
        editor.renderer.updateFull();
      }

      // checkbox function
      function checkToggle(checkName, checkVar, checkElm) {
        if (checkVar) {
          checkElm.checked = true;
        } else {
          checkElm.checked = false;
        }
        settings[checkName] = checkVar;
        updateSettings();
        if (settings.debugMode) {
          console.log(checkName + ": " + settings[checkName]);
        }
      }

      // constant frameCount (great for recompiling)
      let fcTimer = setInterval(function() {
        if (sketchLoaded && p5f.frameCount != undefined) {
          p5vars.frameCount = p5f.frameCount;
          p5vars.mouseX = p5f.mouseX;
          p5vars.mouseY = p5f.mouseY;
        }
      }, 100);

      function p5varsReset() {
        p5vars = { frameCount: 0, mouseX: 0, mouseY: 0 };
      }

      /* TOGGLE EDITOR + [canvas] + MENU */

      // hide/show editor
      function editorToggle() {
        if (p5editor.style.visibility != "visible") {
          p5editor.style.visibility = "visible";
        } else {
          p5editor.style.visibility = "hidden";
        }
        editorToggleUpdate();
      }

      function editorToggleUpdate() {
        if (p5editor.style.visibility != "visible") {
          const canv = document.querySelector("canvas");
          editor.blur();
        } else {
          editor.focus();
        }
      }

      // hide/show canvas
      // future usage for etherpad editing...

      /*
		function canvasToggle(){
			const canv = document.querySelector('canvas');
			//alert(canv);
			if(canv.style.visibility != 'visible'){
				canv.style.visibility = 'visible';
			}else{
				canv.style.visibility = 'hidden';
			}
			canvasToggleUpdate();
		}

		function canvasToggleUpdate(){
			const canv = document.querySelector('canvas');
			if(canv.style.visibility != 'visible'){
				if(sketchLoaded)
					noLoop();
			}else{
				if(sketchLoaded)
					loop();
			}
		}
		*/

      // hide/show menu
      function menuToggle() {
        settings.menuMode = !settings.menuMode;
        updateSettings();
        menuToggleUpdate();
      }

      function menuToggleUpdate() {
        if (!settings.menuMode) {
          menuPanel.style.marginRight = "-250px";
          menuSwitch.innerHTML = "«";
          // menuPanel.style.overflow = "visible"; // test again w/ chromium
        } else {
          menuPanel.style.marginRight = "0px";
          menuSwitch.innerHTML = "»";
          // menuPanel.style.overflow = "hidden";
        }
      }

      // load theme
      function loadTheme() {
        for (let i = 0; i < menuTheme.options.length; i++) {
          let opt = menuTheme.options[i];
          if (settings.theme == opt.value) {
            menuTheme.selectedIndex = i;
          }
        }
      }

      // set theme
      function setTheme(sel) {
        editor.setTheme(menuTheme.value);
        settings.theme = menuTheme.value;
        updateSettings();
      }

      // set themeBG
      function setBG(val) {
        if (settings.themeBG != val) {
          settings.themeBG = "#" + val;
          updateSettings();
          editor.renderer.updateFull();
        }
      }

      // paused for launch.. to visit in future!
      function styleMenu() {
        // buttons
        //setStyle('class', 'menu-button', 'backgroundColor', ColorLuminance(settings.themeBG, .4));
      }

      function setStyle(styleType, styleElm, styleAttribute, styleChange) {
        let elms;
        if (styleType == "class") {
          elms = document.getElementsByClassName(styleElm);
        } else if (styleType == "tag") {
          elms = document.getElementsByTagName(styleElm);
        } else if (styleType == "id") {
          elms = document.getElementById(styleElm);
        }
        for (let i = 0; i < elms.length; i++) {
          elms[i].style[styleAttribute] = styleChange;
        }
      }

      // https://www.sitepoint.com/javascript-generate-lighter-darker-color/
      /*
		function ColorLuminance(hex, lum) {
			// validate hex string
			hex = String(hex).replace(/[^0-9a-f]/gi, '');
			if (hex.length < 6) {
				hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
			}
			lum = lum || 0;

			// convert to decimal and change luminosity
			let rgb = '#', c;
			for (let i = 0; i < 3; i++) {
				c = parseInt(hex.substr(i*2,2), 16);
				c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
				rgb += ('00'+c).substr(c.length);
			}

			return rgb;
		}
		*/

      // adjust fontsize
      function fontSizeAdjust(newVal) {
        settings.fontSize = newVal;
        updateSettings();
        fontSizeUpdate();
      }

      function fontSizeUpdate() {
        if (settingsFontsize !== document.activeElement) {
          settingsFontsize.value = settings.fontSize;
        }
        p5code.style.fontSize = settings.fontSize + "pt";
      }

      /* LOAD VARIOUS SKETCHES */
      function loadDefault() {
        if (!settings.cocoding.active) {
          let newID = "sketch_" + timeStamp();
          let newSketch =
            '<li class="item-sketch" data-type="sketch" data-id="' +
            newID +
            '">' +
            iconFileLines +
            " " +
            newID +
            "</li>";
          let tempHTML = menuSketches.innerHTML;
          menuSketches.innerHTML = newSketch + tempHTML;

          settings.fileName = newID;
          localStorage.setItem(settings.fileName, p5template);
          editor.setValue(p5template, 1);
          editor.gotoLine(7, 1, false);
          updateSettings();
          editor.focus();
          getOrder();
          setTimeout(function() {
            recompile(true);
          }, 100);
        } else if (settings.cocoding.level == "admin") {
          vex.dialog.confirm({
            message: "Replace code with default template?",
            callback: function(value) {
              if (value) {
                cocode.codeReplace({ code: p5template });
                // editor.setValue(p5template, 1);
                // editor.gotoLine(7, 1, false);
                // editor.focus();
              }
            }
          });
        }
      }

      function loadAbout() {
        settings.fileName = "p5liveabout";

        let demosPath = "README.md?" + settings.revision;
        let request = new XMLHttpRequest();
        request.open("GET", demosPath, false);
        request.send();
        let ptContent = htmlToText(markdown.toHTML(request.responseText));

        let p5liveabout = "/*\n\n" + ptContent + "*/\n\n" + p5liveaboutSketch;
        localStorage.setItem(settings.fileName, p5liveabout);
        editor.setValue(p5liveabout, 1);
        editor.focus();
        updateSettings();
        setTimeout(function() {
          recompile(true);
        }, 100);
      }

      // HTML to TXT
      function htmlToText(html) {
        //remove code brakes and tabs
        html = html.replace(/\n/g, "");
        html = html.replace(/\t/g, "");

        //keep html brakes and tabs
        html = html.replace(/<\/td>/g, "\t");
        html = html.replace(/<\/table>/g, "\n");
        html = html.replace(/<\/tr>/g, "\n");
        html = html.replace(/<\/p>/g, "\n\n");
        html = html.replace(/<\/li>/g, "\n");
        html = html.replace(/<\/ul>/g, "\n\n");
        html = html.replace(/<\/div>/g, "\n");
        html = html.replace(/&lt;img([\w\W]+?)&gt;<br\/>/g, "");
        html = html.replace(/<\/h.>/g, "\n----------------\n");
        html = html.replace(/<br>/g, "\n");
        html = html.replace(/<br( )*\/>/g, "\n");
        html = html.replace(/(.{80}.\s)/g, "$1\n");

        //parse html into text
        let dom = new DOMParser().parseFromString(
          "<!doctype html><body>" + html,
          "text/html"
        );
        let links = dom.querySelectorAll("a");
        for (let i = 0; i < links.length; ++i) {
          links[i].innerHTML = links[i].href;
        }
        return dom.body.textContent;
      }

      // Tooltips via tippy
      function loadTippy() {
        tippy(".tippy", {
          content(reference) {
            const title = reference.getAttribute("data-title");
            //reference.removeAttribute('title') // seems ok to leave there...
            return title;
          },
          placement: "bottom",
          arrow: true,
          delay: 0,
          duration: 0,
          arrowType: "round",
          onShow(instance) {
            document.querySelectorAll(".tippy-popper").forEach(popper => {
              if (popper !== instance.popper) {
                popper._tippy.hide();
              }
            });
          }
        });

        tippy(".tippy-left", {
          content(reference) {
            const title = reference.getAttribute("data-title");
            //reference.removeAttribute('title')
            return title;
          },
          placement: "left",
          arrow: true,
          delay: 0,
          duration: 0,
          zIndex: 9999,
          boundary: "window",
          arrowType: "round",
          onShow(instance) {
            document.querySelectorAll(".tippy-popper").forEach(popper => {
              if (popper !== instance.popper) {
                popper._tippy.hide();
              }
            });
          }
        });
      }

      /*	EXPORT ASSETS	*/

      function savePNG() {
        if (sketchLoaded) {
          p5f.save("P5L_" + settings.fileName + "_" + timeStamp() + ".png");
          if (settings.exportCode) {
            exportSketch(settings.fileName);
          }
        }
      }

      function loadHTMLTemplate() {
        let tempPath = "includes/templates/p5live_savehtml.html";
        let request = new XMLHttpRequest();
        request.open("GET", tempPath, false);
        request.send();
        let el = document.createElement("html");
        el.innerHTML = request.responseText;
        p5htmlTemplate = el;
      }

      function saveHTML() {
        let el = p5htmlTemplate.cloneNode(true);
        el.getElementsByTagName("title")[0].innerHTML = settings.fileName;
        let iFrameBody = el.getElementsByTagName("head")[0]; //el.document.getElementsByTagName('body')[0];

        // check loadScripts;
        let sketchTest = editor.getValue();
        sketchTest = sketchTest.replace(/(?:\r\n|\r|\n|\t)/g, "");
        let sketchLoadScriptsRegEx = /loadScripts\s+=\s+\[(.*["']\])/;
        let sketchLoadScripts = sketchLoadScriptsRegEx.exec(sketchTest);
        if (sketchLoadScripts != undefined) {
          sketchLoadScripts = sketchLoadScripts[1]
            .replace(/["']/g, "")
            .replace(/[' '|\]]/g, "")
            .split(",");
          for (let i = 0; i < sketchLoadScripts.length; i++) {
            let s = document.createElement("script");
            s.type = "text/javascript";
            s.src = sketchLoadScripts[i];
            iFrameBody.appendChild(s);
            iFrameBody.innerHTML += "\n\n";
          }
        }

        let s = document.createElement("script");
        s.type = "text/javascript";
        s.innerHTML =
          "\n//" +
          settings.fileName +
          "\n\n" +
          editor.getValue() +
          "\n\n" +
          p5custom.value;
        iFrameBody.appendChild(s);
        iFrameBody.innerHTML += "\n\n";
        download(
          "<!DOCTYPE html>\n<html>\n" + el.innerHTML + "\n</html>",
          "P5L_" + settings.fileName + "_" + timeStamp() + ".html",
          "text/html"
        );
      }

      function timeStamp() {
        return new Date()
          .toISOString()
          .replace(/[^0-9]/g, "")
          .slice(0, -3);
      }

      /* p5.js REFERENCE */

      window.onhashchange = getRef;

      function showRef() {
        if (!downloadedRef) {
          showLoader();
          loadRef();
          downloadedRef = true;
        } else {
          refHolder.style.display = "block";
          getRef();
        }
      }

      function getRef() {
        if (location.hash != undefined && location.hash.length > 1) {
          let refPieces = location.hash.split("/");
          let grabRef = "";
          if (refPieces.length == 3) {
            ref.innerHTML = "";
            grabRef = location.hash.split("/")[2];
          } else {
            allRef();
            // window.location = window.location.hash;
          }

          let snippetIndex = refList
            .map(function(d) {
              return d["name"];
            })
            .indexOf(decodeURI(grabRef));
          let ex = refList[snippetIndex];
          let paramsCollect = [];
          let paramsDesc = [];
          if (ex.overloads != undefined || ex.params != undefined) {
            ref.innerHTML +=
              '<a href="#' +
              ex.module +
              '"><div class="param-title">← ' +
              ex.name +
              "</div></a><br>";
            if (ex.overloads != undefined) {
              ex.overloads.forEach(function(ol) {
                let params = [];
                ol.params.forEach(function(param) {
                  if (param.optional) {
                    params.push("[" + param.name + "]");
                  } else {
                    params.push(param.name);
                  }

                  if (paramsCollect.indexOf(param.name) === -1) {
                    paramsCollect.push(param.name);
                    let paramHTML =
                      '<div class="param"><div class="param-name">' +
                      param.name +
                      "</div> " +
                      param.description
                        .substring(0, param.description.length - 2)
                        .replace(/<p[^>]*>/g, "") +
                      "</div>";
                    paramsDesc.push(paramHTML);
                  }
                });
                let paramsJoin = "";
                if (params.length > 0) {
                  paramsJoin = "(" + params.join(", ") + ")";
                }
                ref.innerHTML +=
                  '<div class="param-code">' + ex.name + paramsJoin + "</div>";
              });
            } else {
              let params = [];
              ex.params.forEach(function(param) {
                if (paramsCollect.indexOf(param.name) === -1) {
                  if (param.optional) {
                    params.push("[" + param.name + "]");
                  } else {
                    params.push(param.name);
                  }
                  let paramHTML =
                    '<div class="param"><div class="param-name">' +
                    param.name +
                    "</div> " +
                    param.description
                      .substring(0, param.description.length - 2)
                      .replace(/<p[^>]*>/g, "") +
                    "</div>";
                  paramsDesc.push(paramHTML);
                  paramsCollect.push(param.name);
                }
              });
              if (ex.module != "Constants") {
                let paramsJoin = "";
                if (params.length > 0) {
                  paramsJoin = "(" + params.join(", ") + ")";
                }
                ref.innerHTML +=
                  '<div class="param-code">' + ex.name + paramsJoin + "</div>";
              }
            }
          } else {
            ref.innerHTML +=
              '<a href="#"><div class="param-title">← ' +
              ex.name +
              "</div></a>";
          }

          let desc = "";
          if (ex.descriptionHTML != undefined) {
            desc = ex.descriptionHTML;
          }

          let refLink =
            '<br><a href="https://p5js.org/reference/#/p5/' +
            grabRef +
            '" target="_blank">» p5.js reference</a>';

          ref.innerHTML +=
            '<br><div class="params"' +
            paramsDesc.join("") +
            "</div><br>" +
            desc +
            refLink;
        } else {
          allRef();
        }
      }

      function allRef() {
        ref.innerHTML = '<div class="ref-title">p5.js reference</div><br>';
        let all = [];
        let grouped = groupBy(refList, c => c.module);
        Object.keys(grouped).forEach(function(k) {
          let modHTML =
            '<div class="module" name="' +
            k +
            '" id="' +
            k +
            '"><div class="module-name">' +
            k +
            "</div>";
          let modAll = [];
          grouped[k].forEach(function(ci) {
            if (ci.name != "") {
              let title = "";
              let desc = "";
              title += ci.code.join("\n") + "\n\n";
              let params = [];
              ci.params.forEach(function(cip) {
                params.push(cip.name + " - " + cip.description);
              });
              title += params.join("\n") + "\n\n";
              if (ci.description != "") {
                desc = ci.description;
              }
              title += desc;
              modAll.push(
                '<a href="#/p5/' +
                  htmlEntities(ci.name) +
                  '" title="' +
                  htmlEntities(title) +
                  '">' +
                  htmlEntities(ci.name) +
                  "</a><br>"
              );
            }
          });
          modHTML += modAll.join("");
          modHTML += "</div>";
          all.push(modHTML);
        });

        ref.innerHTML += '<div id="showall">' + all.join("") + "</div>";

        // jump to category of viewed ref
        if (location.hash != undefined && location.hash.length > 1) {
          let refPieces = location.hash.split("/");
          if (refPieces.length == 1) {
            let refTopic = location.hash.substring(1);

            const overflow = document.getElementById("refholder");
            let anchor = document.getElementById(refTopic);

            const rectOverflow = ref.getBoundingClientRect();
            const rectAnchor = anchor.getBoundingClientRect();

            overflow.scrollTop = rectAnchor.top - rectOverflow.top;
          }
        }

        return false;
      }

      function loadRef() {
        let refPath = "includes/p5/data.js";
        let request = new XMLHttpRequest();
        request.open("GET", refPath, false);
        request.send();
        let jsonObj = JSON.parse(
          request.responseText.replace("referenceData = ", "")
        ).classitems;
        let grouped = groupBy(jsonObj, c => c.module);

        // filter to own needs
        Object.keys(grouped).forEach(function(k) {
          grouped[k].forEach(function(ci) {
            let classItem = {};
            classItem.module = k;
            if (ci.name != undefined) {
              classItem.name = ci.name;
            } else {
              classItem.name = "";
            }
            if (ci.description != undefined) {
              classItem.description = ci.description
                .replace(/<(?:.|\n)*?>/gm, "")
                .replace(/\n/gi, " ");
              classItem.descriptionHTML = ci.description;
            } else {
              classItem.description = "";
            }
            let classCode = [];
            let classParams = [];
            let paramsCollect = [];

            if (ci.overloads != undefined || ci.params != undefined) {
              if (ci.overloads != undefined) {
                ci.overloads.forEach(function(ol) {
                  let params = [];
                  ol.params.forEach(function(param) {
                    if (param.optional) {
                      params.push("[" + param.name + "]");
                    } else {
                      params.push(param.name);
                    }

                    if (paramsCollect.indexOf(param.name) === -1) {
                      paramsCollect.push(param.name);
                      let paramDesc = param.description
                        .substring(0, param.description.length - 1)
                        .replace(/<.*?p[^>]*>/g, "")
                        .replace(/\n/gi, " ");
                      classParams.push({
                        name: param.name,
                        description: paramDesc
                      });
                    }
                  });
                  classCode.push(ci.name + "(" + params.join(", ") + ")");
                });
              } else {
                let params = [];
                ci.params.forEach(function(param) {
                  if (paramsCollect.indexOf(param.name) === -1) {
                    if (param.optional) {
                      params.push("[" + param.name + "]");
                    } else {
                      params.push(param.name);
                    }
                    paramsCollect.push(param.name);
                    let paramDesc = param.description
                      .substring(0, param.description.length - 1)
                      .replace(/<.*?p[^>]*>/g, "")
                      .replace(/\n/gi, " ");
                    classParams.push({
                      name: param.name,
                      description: paramDesc
                    });
                  }
                });
                classCode.push(ci.name + "(" + params.join(", ") + ")");
              }
            }
            classItem.code = classCode;
            classItem.params = classParams;
            refList.push(classItem);
          });
        });
        allRef();
        hideLoader();
        // display once downloaded
        refHolder.style.display = "block";
        getRef();
      }

      // close references
      function closeRef() {
        window.location.hash = "#";
        refHolder.style.display = "none";
      }

      // group references
      function groupBy(xs, f) {
        return xs.reduce(
          (r, v, i, a, k = f(v)) => ((r[k] || (r[k] = [])).push(v), r),
          {}
        );
      }

      // clean up invalid characters
      function htmlEntities(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      /* iFrame magic */

      // get mouse clicks on top
      // initially inspired from here:
      // https://stackoverflow.com/a/44143731/10885535
      window.addEventListener("mousemove", passMouseClick);
      window.addEventListener("mouseup", passMouseClick);
      window.addEventListener("mousedown", passMouseClick);

      let pass = false;
      function passMouse(event) {
        pass = !pass;
        if (pass) {
          processMouse(event);
        }
      }

      function passMouseClick(event) {
        processMouse(event);
      }

      let mouseFields = [
        "altKey",
        "clientX",
        "clientY",
        "composed",
        "ctrlKey",
        "isTrusted",
        "layerX",
        "layerY",
        "metaKey",
        "movementX",
        "movementY",
        "offsetX",
        "offsetY",
        "pageX",
        "pageY",
        "screenX",
        "screenY",
        "shiftKey",
        "x",
        "y",
        "button",
        "buttons",
        "relatedTarget",
        "region"
      ];

      function getOpts(event, fields) {
        let opts = {};
        fields.forEach(function(f) {
          if (f in event) {
            opts[f] = event[f];
          }
        });
        return opts;
      }

      function processMouse(event) {
        let opts = getOpts(event, mouseFields);
        let copy = new MouseEvent(event.type, event);
        if (settings.cocoding.active && settings.cocoding.sync) {
          if (settings.cocoding.level == "admin") {
            if (p5editor.style.visibility == "visible") {
              p5f.dispatchEvent(copy);
            }
            cocode.dispatchSyncEvent("mouse", event.type, opts);
          }
        } else {
          if (p5editor.style.visibility == "visible") {
            p5f.dispatchEvent(copy);
          }
        }

        // prevent drag+drop+shift of code, while mouseDragging visuals
        if (event.type == "mousedown") {
          editor.setReadOnly(true);
        } else if (event.type == "mouseup") {
          if (
            !settings.cocoding.active ||
            (settings.cocoding.active &&
              (settings.cocoding.level == "admin" ||
                settings.cocoding.writemode ||
                !settings.cocoding.lockdown))
          ) {
            editor.setReadOnly(false);
          }
        }
      }

      // pass keys on down
      // tips: https://stackoverflow.com/questions/596481/
      window.addEventListener("keydown", sendKey);
      window.addEventListener("keyup", sendKey);

      let keyFields = [
        "altKey",
        "bubbles",
        "cancelBubble",
        "cancelable",
        "charCode",
        "code",
        "composed",
        "ctrlKey",
        "isTrusted",
        "key",
        "keyCode",
        "location",
        "metaKey",
        "repeat",
        "returnValue",
        "shiftKey",
        "type",
        "which"
      ];

      function sendKey(event) {
        let opts = getOpts(event, keyFields);
        let copy = new KeyboardEvent(event.type, event);

        if (settings.cocoding.active && settings.cocoding.sync) {
          if (settings.cocoding.level == "admin") {
            p5f.dispatchEvent(copy);
            cocode.dispatchSyncEvent("keyboard", event.type, opts);
          }
        } else {
          p5f.dispatchEvent(copy);
        }
      }

      /*	MISC */
      function pop720() {
        window.open(
          window.location.href,
          "mywindow",
          "menubar=0,resizable=0,width=720,height=748"
        );
      }

      function showLoader() {
        loader.style.display = "block";
      }

      function hideLoader() {
        loader.style.display = "none";
      }

      /* View in fullscreen */
      function openFullscreen() {
        let elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.mozRequestFullScreen) {
          /* Firefox */
          elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
          /* Chrome, Safari and Opera */
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          /* IE/Edge */
          elem.msRequestFullscreen();
        }
      }

      /* Close fullscreen */
      function closeFullscreen() {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
          /* Firefox */
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          /* Chrome, Safari and Opera */
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          /* IE/Edge */
          document.msExitFullscreen();
        }
      }

      /*	COCODING */
      function makeid(charCount) {
        let text = "";
        for (let i = 0; i < charCount; i++)
          text += chars.charAt(Math.floor(Math.random() * chars.length));
        return text;
      }

      function cocodingInit() {
        if (settings.cocoding.active) {
          vex.dialog.confirm({
            message: "Exit COCODING?",
            callback: function(value) {
              if (value) {
                cocodingExit(loadLatest());
              }
            }
          });
        } else {
          cocodingReset();
          let sessID = makeid(5);
          settings.cocoding.active = true;
          settings.cocoding.token = hashCode(sessID);
          updateSettings();
          document.location.search = "cc=" + sessID;
        }
      }

      function hashCode(s) {
        let h;
        for (let i = 0; i < s.length; i++)
          h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;

        return h;
      }

      function cocodingExit(sketch) {
        cocodingReset();
        settings.fileName = sketch;
        updateSettings;
        // loadSketch(settings.fileName);
        window.history.replaceState(null, null, window.location.pathname);
        window.location = window.location.pathname;
      }

      function cocoding() {
        menuCocodeHolder.style.display = "block";
        editor.setValue(
          "// Loading COCODING Session: " + settings.cocoding.namespace,
          1
        );
        cocode = new CocodeApp(settings.cocoding.namespace);
        // consoleMessage("When COCODING, code in editor is a sandbox. Clone it regularly to access later.", 0);
      }

      // reset all cocoding except nick + color
      function cocodingReset() {
        Object.keys(initSettings.cocoding).forEach(function(cc) {
          if (cc != "nick" && cc != "color") {
            settings.cocoding[cc] = initSettings.cocoding[cc];
          }
        });
        updateSettings();
      }

      function copyLink(elm) {
        let dummy = document.createElement("input"),
          text = window.location.href;

        document.body.appendChild(dummy);
        dummy.value = text;
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);

        // share info
        let oldContent = elm._tippy.props.content;
        elm._tippy.setContent("Copied!");
        elm._tippy.show(200);
        setTimeout(function() {
          elm._tippy.hide();
          elm._tippy.setContent(oldContent);
        }, 800);
      }

      function cocodeLayers() {
        vex.dialog.confirm({
          message: "Replace current code with CoCodeLayers?",
          callback: function(value) {
            if (value) {
              let collabPath = "includes/demos/P5L_cocodeLayers_20190429.json";
              let request = new XMLHttpRequest();
              request.open("GET", collabPath, false);
              request.send();
              let jsonObj = JSON.parse(request.responseText);
              editor.setValue(jsonObj.sketches[0].sketchCode, 1);
            }
          }
        });
      }

      function toggleLockdown() {
        settings.cocoding.lockdown = !settings.cocoding.lockdown;
        updateSettings();
        cocode.lockdown(settings.cocoding.lockdown);
      }

      function updateToggleLockdown() {
        let settingsLockdown = document.getElementById("cocode-lockdown");
        if (settings.cocoding.lockdown) {
          settingsLockdown.innerHTML = iconLock;
        } else {
          settingsLockdown.innerHTML = iconUnlock;
        }
        toggleButtonActive(settingsLockdown, settings.cocoding.lockdown);

        if (settings.cocoding.level == "admin") {
          let settingsSync = document.getElementById("cocode-sync");
          if (settings.cocoding.lockdown) {
            settingsSync.removeAttribute("disabled");
          } else {
            settingsSync.setAttribute("disabled", "disabled");
            settings.cocoding.sync = false;
            updateToggleSync();
          }
        }
        updateSettings();
      }

      function toggleSync() {
        settings.cocoding.sync = !settings.cocoding.sync;
        updateSettings();
        updateToggleSync();
        cocode.sync(settings.cocoding.sync);
      }

      function updateToggleSync() {
        let settingsSync = document.getElementById("cocode-sync");
        toggleButtonActive(settingsSync, settings.cocoding.sync);
      }

      function toggleButtonActive(elm, toggleMode) {
        if (toggleMode) {
          elm.classList.add("cocoding-active");
        } else {
          elm.classList.remove("cocoding-active");
        }
      }
    </script>
  </body>
</html>
